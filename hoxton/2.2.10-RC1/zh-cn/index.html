<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Jim Fang, Jing Xiao, Mercy Ma, Xiaolong Zuo, Bingting Peng, Yuxin Wang">
<title>Spring Cloud Alibaba 参考文档</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
</head>
<body id="spring-cloud-alibaba-reference" class="book">
<div id="header">
<h1>Spring Cloud Alibaba 参考文档</h1>
<div class="details">
<span id="author" class="author">Jim Fang, Jing Xiao, Mercy Ma, Xiaolong Zuo, Bingting Peng, Yuxin Wang</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_介绍">1. 介绍</a></li>
<li><a href="#_依赖管理">2. 依赖管理</a></li>
<li><a href="#_spring_cloud_alibaba_nacos_discovery">3. Spring Cloud Alibaba Nacos Discovery</a>
<ul class="sectlevel2">
<li><a href="#_服务注册发现_nacos_discovery">3.1. 服务注册/发现: Nacos Discovery</a></li>
<li><a href="#_如何引入_nacos_discovery_进行服务注册发现">3.2. 如何引入 Nacos Discovery 进行服务注册/发现</a></li>
<li><a href="#_一个使用_nacos_discovery_进行服务注册发现并调用的例子">3.3. 一个使用 Nacos Discovery 进行服务注册/发现并调用的例子</a>
<ul class="sectlevel3">
<li><a href="#_nacos_server_启动">3.3.1. Nacos Server 启动</a></li>
<li><a href="#_provider_应用">3.3.2. Provider 应用</a></li>
<li><a href="#_consumer_应用">3.3.3. Consumer 应用</a></li>
</ul>
</li>
<li><a href="#_nacos_discovery_对外暴露的_endpoint">3.4. Nacos Discovery 对外暴露的 Endpoint</a></li>
<li><a href="#_如何开启权重路由">3.5. 如何开启权重路由</a>
<ul class="sectlevel3">
<li><a href="#_ribbon">3.5.1. Ribbon</a></li>
</ul>
</li>
<li><a href="#_ipv4至ipv6地址迁移方案">3.6. IPv4至IPv6地址迁移方案</a>
<ul class="sectlevel3">
<li><a href="#_ipv4和ipv6地址双注册">3.6.1. IPv4和IPv6地址双注册</a></li>
<li><a href="#_仅注册ipv4">3.6.2. 仅注册IPv4</a></li>
<li><a href="#_仅注册ipv6">3.6.3. 仅注册IPv6</a></li>
</ul>
</li>
<li><a href="#_关于_nacos_discovery_starter_更多的配置项信息">3.7. 关于 Nacos Discovery Starter 更多的配置项信息</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_nacos_config">4. Spring Cloud Alibaba Nacos Config</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_nacos_config_进行配置管理">4.1. 如何引入 Nacos Config 进行配置管理</a></li>
<li><a href="#_快速开始">4.2. 快速开始</a>
<ul class="sectlevel3">
<li><a href="#_nacos_服务端初始化">4.2.1. Nacos 服务端初始化</a></li>
<li><a href="#_客户端使用方式">4.2.2. 客户端使用方式</a></li>
</ul>
</li>
<li><a href="#_基于_dataid_为_yaml_的文件扩展名配置方式">4.3. 基于 DataId 为 yaml 的文件扩展名配置方式</a></li>
<li><a href="#_支持配置的动态更新">4.4. 支持配置的动态更新</a></li>
<li><a href="#_支持profile粒度的配置">4.5. 支持profile粒度的配置</a></li>
<li><a href="#_支持自定义_namespace_的配置">4.6. 支持自定义 namespace 的配置</a></li>
<li><a href="#_支持自定义_group_的配置">4.7. 支持自定义 Group 的配置</a></li>
<li><a href="#_支持自定义扩展的_data_id_配置">4.8. 支持自定义扩展的 Data Id 配置</a></li>
<li><a href="#_配置的优先级">4.9. 配置的优先级</a></li>
<li><a href="#_nacos_config_对外暴露的_endpoint">4.10. Nacos Config 对外暴露的 Endpoint</a></li>
<li><a href="#_完全关闭_nacos_config_的自动化配置">4.11. 完全关闭 Nacos Config 的自动化配置</a></li>
<li><a href="#_关于_nacos_config_starter_更多的配置项信息">4.12. 关于 Nacos Config Starter 更多的配置项信息</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_sentinel">5. Spring Cloud Alibaba Sentinel</a>
<ul class="sectlevel2">
<li><a href="#_sentinel_介绍">5.1. Sentinel 介绍</a></li>
<li><a href="#_如何使用_sentinel">5.2. 如何使用 Sentinel</a>
<ul class="sectlevel4">
<li><a href="#_sentinel_控制台">Sentinel 控制台</a></li>
<li><a href="#_配置控制台信息">5.2.2. 配置控制台信息</a></li>
</ul>
</li>
<li><a href="#_openfeign_支持">5.3. OpenFeign 支持</a></li>
<li><a href="#_resttemplate_支持">5.4. RestTemplate 支持</a></li>
<li><a href="#_动态数据源支持">5.5. 动态数据源支持</a></li>
<li><a href="#_zuul_支持">5.6. Zuul 支持</a></li>
<li><a href="#_spring_cloud_gateway_支持">5.7. Spring Cloud Gateway 支持</a></li>
<li><a href="#_sentinel_对外暴露的_endpoint">5.8. Sentinel 对外暴露的 Endpoint</a></li>
<li><a href="#_关于_sentinel_starter_更多的配置项信息">5.9. 关于 Sentinel Starter 更多的配置项信息</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_rocketmq_binder">6. Spring Cloud Alibaba RocketMQ Binder</a>
<ul class="sectlevel2">
<li><a href="#_rocketmq_介绍">6.1. RocketMQ 介绍</a></li>
<li><a href="#_rocketmq_基本使用">6.2. RocketMQ 基本使用</a></li>
<li><a href="#_spring_cloud_stream_介绍">6.3. Spring Cloud Stream 介绍</a></li>
<li><a href="#_如何使用_spring_cloud_alibaba_rocketmq_binder">6.4. 如何使用 Spring Cloud Alibaba RocketMQ Binder</a></li>
<li><a href="#_spring_cloud_alibaba_rocketmq_binder_实现">6.5. Spring Cloud Alibaba RocketMQ Binder 实现</a></li>
<li><a href="#_messagesource_支持">6.6. MessageSource 支持</a></li>
<li><a href="#_配置选项">6.7. 配置选项</a>
<ul class="sectlevel3">
<li><a href="#_rocketmq_binder_properties">6.7.1. RocketMQ Binder Properties</a></li>
<li><a href="#_rocketmq_consumer_properties">6.7.2. RocketMQ Consumer Properties</a></li>
<li><a href="#_rocketmq_provider_properties">6.7.3. RocketMQ Provider Properties</a></li>
</ul>
</li>
<li><a href="#_阿里云_mq_服务">6.8. 阿里云 MQ 服务</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alicloud_ans">7. Spring Cloud AliCloud ANS</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_spring_cloud_alicloud_ans">7.1. 如何引入 Spring Cloud AliCloud ANS</a></li>
<li><a href="#_使用ans进行服务注册">7.2. 使用ANS进行服务注册</a></li>
<li><a href="#_启动注册中心">7.3. 启动注册中心</a>
<ul class="sectlevel3">
<li><a href="#_启动轻量版配置中心">7.3.1. 启动轻量版配置中心</a></li>
<li><a href="#_使用云上注册中心">7.3.2. 使用云上注册中心</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_spring_cloud_alicloud_acm">8. Spring Cloud AliCloud ACM</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_spring_cloud_alicloud_acm">8.1. 如何引入 Spring Cloud AliCloud ACM</a></li>
<li><a href="#_使用_acm_进行配置管理">8.2. 使用 ACM 进行配置管理</a>
<ul class="sectlevel3">
<li><a href="#_启动配置中心">8.2.1. 启动配置中心</a>
<ul class="sectlevel4">
<li><a href="#_使用轻量版配置中心">使用轻量版配置中心</a></li>
<li><a href="#_使用阿里云配置中心">使用阿里云配置中心</a></li>
</ul>
</li>
<li><a href="#_在配置中心添加配置">8.2.2. 在配置中心添加配置</a></li>
<li><a href="#_启动应用验证">8.2.3. 启动应用验证</a></li>
</ul>
</li>
<li><a href="#_更改配置文件扩展名">8.3. 更改配置文件扩展名</a></li>
<li><a href="#_动态更新">8.4. 动态更新</a></li>
<li><a href="#_profile_粒度的配置">8.5. Profile 粒度的配置</a></li>
<li><a href="#_自定义配置中心超时时间">8.6. 自定义配置中心超时时间</a></li>
<li><a href="#_自定义_group_的配置">8.7. 自定义 Group 的配置</a></li>
<li><a href="#_共享配置">8.8. 共享配置</a></li>
<li><a href="#_actuator_监控">8.9. Actuator 监控</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alicloud_oss">9. Spring Cloud AliCloud OSS</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_spring_cloud_alicloud_oss">9.1. 如何引入 Spring Cloud AliCloud OSS</a></li>
<li><a href="#_如何使用_oss_api">9.2. 如何使用 OSS API</a>
<ul class="sectlevel3">
<li><a href="#_配置_oss">9.2.1. 配置 OSS</a></li>
<li><a href="#_引入_oss_api">9.2.2. 引入 OSS API</a></li>
</ul>
</li>
<li><a href="#_与_spring_框架的_resource_结合">9.3. 与 Spring 框架的 Resource 结合</a></li>
<li><a href="#_采用_sts_授权">9.4. 采用 STS 授权</a></li>
<li><a href="#_更多客户端配置">9.5. 更多客户端配置</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alicloud_schedulerx">10. Spring Cloud AliCloud SchedulerX</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_spring_cloud_alicloud_schedulerx">10.1. 如何引入 Spring Cloud AliCloud SchedulerX</a></li>
<li><a href="#_启动schedulerx任务调度">10.2. 启动SchedulerX任务调度</a></li>
<li><a href="#_编写一个简单任务">10.3. 编写一个简单任务</a></li>
<li><a href="#_对任务进行调度">10.4. 对任务进行调度</a></li>
<li><a href="#_生产环境使用">10.5. 生产环境使用</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alicloud_sms">11. Spring Cloud AliCloud SMS</a>
<ul class="sectlevel2">
<li><a href="#_如何引入_spring_cloud_alicloud_sms">11.1. 如何引入 Spring Cloud AliCloud SMS</a></li>
<li><a href="#_如何使用_sms_api">11.2. 如何使用 SMS API</a>
<ul class="sectlevel3">
<li><a href="#_配置_sms">11.2.1. 配置 SMS</a></li>
<li><a href="#_引入_sms_api">11.2.2. 引入 SMS API</a></li>
</ul>
</li>
<li><a href="#_sms_api_的高级功能">11.3. SMS Api 的高级功能</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_sidecar">12. Spring Cloud Alibaba Sidecar</a>
<ul class="sectlevel2">
<li><a href="#_术语">12.1. 术语</a>
<ul class="sectlevel3">
<li><a href="#_异构微服务">12.1.1. 异构微服务</a></li>
<li><a href="#_完美整合的三层含义">12.1.2. "完美整合"的三层含义</a></li>
</ul>
</li>
<li><a href="#_why_or_why_not">12.2. Why or Why not?</a>
<ul class="sectlevel3">
<li><a href="#_为什么要编写alibaba_sidecar">12.2.1. 为什么要编写Alibaba Sidecar？</a></li>
<li><a href="#_为什么不用service_mesh">12.2.2. 为什么不用Service Mesh？</a></li>
</ul>
</li>
<li><a href="#_原理">12.3. 原理</a></li>
<li><a href="#_要求">12.4. 要求</a></li>
<li><a href="#_使用示例">12.5. 使用示例</a>
<ul class="sectlevel3">
<li><a href="#_示例代码以nacos服务发现为例">12.5.1. 示例代码（以Nacos服务发现为例）</a></li>
<li><a href="#_异构微服务_2">12.5.2. 异构微服务</a></li>
<li><a href="#_测试">12.5.3. 测试</a>
<ul class="sectlevel4">
<li><a href="#_测试1spring_cloud微服务完美调用异构微服务">测试1：Spring Cloud微服务完美调用异构微服务</a></li>
<li><a href="#_测试2异构微服务完美调用spring_cloud微服务">测试2：异构微服务完美调用Spring Cloud微服务</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_alibaba_sidecar优缺点分析">12.6. Alibaba Sidecar优缺点分析</a></li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_appactive">13. Spring Cloud Alibaba AppActive</a>
<ul class="sectlevel2">
<li><a href="#_appactive介绍">13.1. AppActive介绍</a>
<ul class="sectlevel3">
<li><a href="#_单元分流">13.1.1. 单元分流</a>
<ul class="sectlevel4">
<li><a href="#_流量统一接入">流量统一接入</a></li>
<li><a href="#_分流模式">分流模式</a></li>
<li><a href="#_分流粒度">分流粒度</a></li>
<li><a href="#_流量协议">流量协议</a></li>
<li><a href="#_路由透传">路由透传</a></li>
</ul>
</li>
<li><a href="#_单元协同">13.1.2. 单元协同</a>
<ul class="sectlevel4">
<li><a href="#_中心调用">中心调用</a></li>
</ul>
</li>
<li><a href="#_单元保护">13.1.3. 单元保护</a>
<ul class="sectlevel4">
<li><a href="#_接入层纠错">接入层纠错</a></li>
<li><a href="#_rpc纠错">RPC纠错</a></li>
</ul>
</li>
<li><a href="#_单元扩展">13.1.4. 单元扩展</a>
<ul class="sectlevel4">
<li><a href="#_水平扩展">水平扩展</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_如何使用appactive">13.2. 如何使用AppActive</a>
<ul class="sectlevel3">
<li><a href="#_数据面">13.2.1. 数据面</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_spring_cloud_alibaba_governance">14. Spring Cloud Alibaba Governance</a>
<ul class="sectlevel2">
<li><a href="#_配置转换">14.1. 配置转换</a></li>
<li><a href="#_路由">14.2. 路由</a>
<ul class="sectlevel3">
<li><a href="#_组件支持说明">14.2.1. 组件支持说明</a></li>
<li><a href="#_使用路由">14.2.2. 使用路由</a></li>
</ul>
</li>
<li><a href="#_服务鉴权">14.3. 服务鉴权</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_介绍">1. 介绍</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
</div>
<div class="paragraph">
<p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里分布式应用解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
</div>
<div class="paragraph">
<p>目前 Spring Cloud Alibaba 提供了如下功能:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>服务限流降级</strong>：支持 WebServlet、WebFlux, OpenFeign、RestTemplate、Dubbo 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</p>
</li>
<li>
<p><strong>服务注册与发现</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</p>
</li>
<li>
<p><strong>分布式配置管理</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</p>
</li>
<li>
<p><strong>Rpc服务</strong>：扩展 Spring Cloud 客户端 RestTemplate 和 OpenFeign，支持调用 Dubbo RPC 服务</p>
</li>
<li>
<p><strong>消息驱动能力</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</p>
</li>
<li>
<p><strong>分布式事务</strong>：使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。</p>
</li>
<li>
<p><strong>阿里云对象存储</strong>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</p>
</li>
<li>
<p><strong>分布式任务调度</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</p>
</li>
<li>
<p><strong>阿里云短信服务</strong>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Spring Cloud Alibaba 也提供了丰富的 <a href="https://github.com/alibaba/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-examples">examples</a>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_依赖管理">2. 依赖管理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Alibaba BOM 包含了它所使用的所有依赖的版本。</p>
</div>
<div class="paragraph">
<p>如果您是 Maven Central 用户，请将我们的 BOM 添加到您的 pom.xml 中的 &lt;dependencyManagement&gt; 部分。 这将允许您省略任何Maven依赖项的版本，而是将版本控制委派给BOM。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;
            &lt;version&gt;2.2.10-RC1&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>在下面的章节中，假设您使用的是 Spring Cloud Alibaba bom，相关 starter 依赖将不包含版本号。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_nacos_discovery">3. Spring Cloud Alibaba Nacos Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nacos 是一个 Alibaba 开源的、易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p>
</div>
<div class="paragraph">
<p>使用 Spring Cloud Alibaba Nacos Discovery，可基于 Spring Cloud 的编程模型快速接入 Nacos 服务注册功能。</p>
</div>
<div class="sect2">
<h3 id="_服务注册发现_nacos_discovery">3.1. 服务注册/发现: Nacos Discovery</h3>
<div class="paragraph">
<p>服务发现是微服务架构体系中最关键的组件之一。如果尝试着用手动的方式来给每一个客户端来配置所有服务提供者的服务列表是一件非常困难的事，而且也不利于
服务的动态扩缩容。Nacos Discovery 可以帮助您将服务自动注册到 Nacos 服务端并且能够动态感知和刷新某个服务实例的服务列表。除此之外，Nacos
Discovery 也将服务实例自身的一些元数据信息-例如 host，port, 健康检查URL，主页等内容注册到 Nacos。Nacos 的获取和启动方式可以参考 <a href="https://nacos.io/zh-cn/docs/quick-start.html">Nacos 官网</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_如何引入_nacos_discovery_进行服务注册发现">3.2. 如何引入 Nacos Discovery 进行服务注册/发现</h3>
<div class="paragraph">
<p>如果要在您的项目中使用 Nacos 来实现服务注册/发现，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alibaba-nacos-discovery</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_一个使用_nacos_discovery_进行服务注册发现并调用的例子">3.3. 一个使用 Nacos Discovery 进行服务注册/发现并调用的例子</h3>
<div class="paragraph">
<p>Nacos Discovery 适配了 Netflix Ribbon，可以使用 RestTemplate 或 OpenFeign 进行服务的调用。</p>
</div>
<div class="sect3">
<h4 id="_nacos_server_启动">3.3.1. Nacos Server 启动</h4>
<div class="paragraph">
<p>具体启动方式参考 <a href="https://nacos.io/zh-cn/docs/quick-start.html">Nacos 官网</a>。</p>
</div>
<div class="paragraph">
<p>Nacos Server 启动后，进入 <a href="http://ip:8848" class="bare">http://ip:8848</a> 查看控制台(默认账号名/密码为 nacos/nacos):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://img.alicdn.com/tfs/TB1dyWJbQL0gK0jSZFtXXXQCXXa-2788-1086.png" alt="TB1dyWJbQL0gK0jSZFtXXXQCXXa 2788 1086">
</div>
<div class="title">Figure 1. Nacos Dashboard</div>
</div>
<div class="paragraph">
<p>关于更多的 Nacos Server 版本，可以从 <a href="https://github.com/alibaba/nacos/releases">release 页面</a> 下载最新的版本。</p>
</div>
</div>
<div class="sect3">
<h4 id="_provider_应用">3.3.2. Provider 应用</h4>
<div class="paragraph">
<p>以下步骤向您展示了如何将一个服务注册到 Nacos。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pom.xml的配置。一个完整的 pom.xml 配置如下所示：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;open.source.test&lt;/groupId&gt;
    &lt;artifactId&gt;nacos-discovery-test&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;nacos-discovery-test&lt;/name&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;${spring.boot.version}&lt;/version&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring.cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring.cloud.alibaba.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>application.properties 配置。一些关于 Nacos 基本的配置也必须在 application.properties(也可以是application.yaml)配置，如下所示：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">server.port=8081
spring.application.name=nacos-provider
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
management.endpoints.web.exposure.include=*</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
如果不想使用 Nacos 作为您的服务注册与发现，可以将 <code>spring.cloud.nacos.discovery</code> 设置为 <code>false</code>。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>启动 Provider 示例。如下所示：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
public class NacosProviderDemoApplication {

    public static void main(String[] args) {
        SpringApplication.run(NacosProviderDemoApplication.class, args);
    }

    @RestController
    public class EchoController {
        @GetMapping(value = "/echo/{string}")
        public String echo(@PathVariable String string) {
            return "Hello Nacos Discovery " + string;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个时候你就可以在 Nacos的控制台上看到注册上来的服务信息了。</p>
</div>
</div>
<div class="sect3">
<h4 id="_consumer_应用">3.3.3. Consumer 应用</h4>
<div class="paragraph">
<p>Consumer 应用可能还没像启动一个 Provider 应用那么简单。因为在 Consumer 端需要去调用 Provider 端提供的REST 服务。例子中我们使用最原始的一种方式，
即显示的使用 LoadBalanceClient 和 RestTemplate 结合的方式来访问。
pom.xml 和 application.properties 的配置可以参考 1.2 小结。启动一个 Consumer应用的示例代码如下所示：</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
通过带有负载均衡的RestTemplate 和 FeignClient 也是可以访问的。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
public class NacosConsumerApp {

    @RestController
    public class NacosController{

        @Autowired
        private LoadBalancerClient loadBalancerClient;
        @Autowired
        private RestTemplate restTemplate;

        @Value("${spring.application.name}")
        private String appName;

        @GetMapping("/echo/app-name")
        public String echoAppName(){
            //使用 LoadBalanceClient 和 RestTemplate 结合的方式来访问
            ServiceInstance serviceInstance = loadBalancerClient.choose("nacos-provider");
            String url = String.format("http://%s:%s/echo/%s",serviceInstance.getHost(),serviceInstance.getPort(),appName);
            System.out.println("request url:"+url);
            return restTemplate.getForObject(url,String.class);
        }

    }

    //实例化 RestTemplate 实例
    @Bean
    public RestTemplate restTemplate(){

        return new RestTemplate();
    }

    public static void main(String[] args) {

        SpringApplication.run(NacosConsumerApp.class,args);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个例子中我们注入了一个 LoadBalancerClient 的实例，并且手动的实例化一个 RestTemplate，同时将 <code>spring.application.name</code> 的配置值 注入到应用中来，
目的是调用 Provider 提供的服务时，希望将当前配置的应用名给显示出来。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
在启动 Consumer 应用之前请先将 Nacos 服务启动好。具体启动方式可参考 <a href="https://nacos.io/zh-cn/docs/quick-start.html">Nacos 官网</a>。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>启动后，访问 Consumer 提供出来的 <code><a href="http://ip:port/echo/app-name" class="bare">http://ip:port/echo/app-name</a></code> 接口。我这里测试启动的 port是 8082。访问结果如下所示：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>访问地址：http://127.0.0.1:8082/echo/app-name
访问结果：Hello Nacos Discovery nacos-consumer</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nacos_discovery_对外暴露的_endpoint">3.4. Nacos Discovery 对外暴露的 Endpoint</h3>
<div class="paragraph">
<p>Nacos Discovery 内部提供了一个 Endpoint, 对应的 endpoint id 为 <code>nacos-discovery</code>。</p>
</div>
<div class="paragraph">
<p>Endpoint 暴露的 json 中包含了两种属性:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>subscribe: 显示了当前服务有哪些服务订阅者</p>
</li>
<li>
<p>NacosDiscoveryProperties: 当前应用 Nacos 的基础配置信息</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>这是 Endpoint 暴露的 json 示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
  "subscribe": [
    {
      "jsonFromServer": "",
      "name": "nacos-provider",
      "clusters": "",
      "cacheMillis": 10000,
      "hosts": [
        {
          "instanceId": "30.5.124.156#8081#DEFAULT#nacos-provider",
          "ip": "30.5.124.156",
          "port": 8081,
          "weight": 1.0,
          "healthy": true,
          "enabled": true,
          "cluster": {
            "serviceName": null,
            "name": null,
            "healthChecker": {
              "type": "TCP"
            },
            "defaultPort": 80,
            "defaultCheckPort": 80,
            "useIPPort4Check": true,
            "metadata": {

            }
          },
          "service": null,
          "metadata": {

          }
        }
      ],
      "lastRefTime": 1541755293119,
      "checksum": "e5a699c9201f5328241c178e804657e11541755293119",
      "allIPs": false,
      "key": "nacos-provider",
      "valid": true
    }
  ],
  "NacosDiscoveryProperties": {
    "serverAddr": "127.0.0.1:8848",
    "endpoint": "",
    "namespace": "",
    "logName": "",
    "service": "nacos-provider",
    "weight": 1.0,
    "clusterName": "DEFAULT",
    "metadata": {

    },
    "registerEnabled": true,
    "ip": "30.5.124.201",
    "networkInterface": "",
    "port": 8082,
    "secure": false,
    "accessKey": "",
    "secretKey": ""
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何开启权重路由">3.5. 如何开启权重路由</h3>
<div class="sect3">
<h4 id="_ribbon">3.5.1. Ribbon</h4>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">[service_name].ribbon.NFLoadBalancerRuleClassName=com.alibaba.cloud.nacos.ribbon.NacosRule</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ipv4至ipv6地址迁移方案">3.6. IPv4至IPv6地址迁移方案</h3>
<div class="paragraph">
<p>Spring Cloud Alibaba 提供了使用双注册双订阅方式帮助用户实现应用IPv4向IPv6不停机迁移，在使用相关功能之前，需要在服务消费者应用 application.properties 配置客户端负载均衡为 Spring Cloud Alibaba 所提供的 NacosRule 负载均衡算法，配置方式如下，注意需要将[service-name]替换成具体的待消费服务名。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[service-name].ribbon.NFLoadBalancerRuleClassName=com.alibaba.cloud.nacos.ribbon.NacosRule</pre>
</div>
</div>
<div class="sect3">
<h4 id="_ipv4和ipv6地址双注册">3.6.1. IPv4和IPv6地址双注册</h4>
<div class="paragraph">
<p>在配置完成NacosRule作为负载均衡策略后，应用启动后会默认将微服务的IPv4地址和IPv6地址注册到注册中心中，其中IPv4地址会存放在Nacos服务列表中的IP字段下，IPv6地址在Nacos的metadata字段中，其对应的Key为IPv6。当服务消费者调用服务提供者时，会根据自身的IP地址栈支持情况，选择合适的IP地址类型发起服务调用。具体规则：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>服务消费者本身支持IPv4和IPv6双地址栈或仅支持IPv6地址栈的情况下，服务消费者会使用服务提供的IPv6地址发起服务调用，IPv6地址调用失败如本身还同事支持IPv4地址栈时，暂不支持切换到IPv4再发起重试调用；</p>
</li>
<li>
<p>服务消费者本身仅支持IPv4单地址栈的情况下，服务消费者会使用服务提供的IPv4地址发起服务调用。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_仅注册ipv4">3.6.2. 仅注册IPv4</h4>
<div class="paragraph">
<p>如果您只想使用IPv4地址进行注册，可以在application.properties使用以下配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.nacos.discovery.ip-type=IPv4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_仅注册ipv6">3.6.3. 仅注册IPv6</h4>
<div class="paragraph">
<p>如果您只想使用IPv6地址，可以在application.properties使用以下配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.nacos.discovery.ip-type=IPv6</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_关于_nacos_discovery_starter_更多的配置项信息">3.7. 关于 Nacos Discovery Starter 更多的配置项信息</h3>
<div class="paragraph">
<p>更多关于 Nacos Discovery Starter 的配置项如下所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">说明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务端地址</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.server-addr</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nacos Server 启动监听的ip地址和端口</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${spring.application.name}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">注册的服务名</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">权重</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.weight</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取值范围 1 到 100，数值越大，权重越大</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">网卡名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.network-interface</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当IP未配置时，注册的IP为此网卡所对应的IP地址，如果此项也未配置，则默认取第一块网卡的地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">注册的IP地址</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.ip</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">优先级最高</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">注册的IP地址类型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.ip-type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IPv4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可以配置IPv4和IPv6两种类型，如果网卡同类型IP地址存在多个，希望制定特定网段地址，可使用`spring.cloud.inetutils.preferred-networks`配置筛选地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">注册的端口</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认情况下不用配置，会自动探测</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">命名空间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.namespace</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">常用场景之一是不同环境的注册的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AccessKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.access-key</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当要上阿里云时，阿里云上面的一个云账号名</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecretKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.secret-key</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当要上阿里云时，阿里云上面的一个云账号密码</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.metadata</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">使用Map格式配置，用户可以根据自己的需要自定义一些和服务相关的元数据信息</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">日志文件名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.log-name</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.cluster-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nacos集群名称</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">接入点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">地域的某个服务的入口域名，通过此域名可以动态地拿到服务端地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否集成Ribbon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ribbon.nacos.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">一般都设置成true即可</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否开启Nacos Watch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.discovery.watch.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可以设置成false来关闭 watch</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_nacos_config">4. Spring Cloud Alibaba Nacos Config</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nacos 是一个 Alibaba 开源的、易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p>
</div>
<div class="paragraph">
<p>使用 Spring Cloud Alibaba Nacos Config，可基于 Spring Cloud 的编程模型快速接入 Nacos 配置管理功能。</p>
</div>
<div class="sect2">
<h3 id="_如何引入_nacos_config_进行配置管理">4.1. 如何引入 Nacos Config 进行配置管理</h3>
<div class="paragraph">
<p>如果要在您的项目中使用 Nacos 来实现配置管理，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alibaba-nacos-config</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_快速开始">4.2. 快速开始</h3>
<div class="paragraph">
<p>Nacos Config 使用 DataId 和 GROUP 确定一个配置。</p>
</div>
<div class="paragraph">
<p>下图表示 DataId 使用 <code>myDataid</code>, GROUP 使用 <code>DEFAULT_GROUP</code>，配置格式为 Properties 的一个配置项:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://img.alicdn.com/tfs/TB1Yli3bUY1gK0jSZFMXXaWcVXa-2436-1138.png" alt="TB1Yli3bUY1gK0jSZFMXXaWcVXa 2436 1138">
</div>
<div class="title">Figure 2. Nacos Config Item</div>
</div>
<div class="sect3">
<h4 id="_nacos_服务端初始化">4.2.1. Nacos 服务端初始化</h4>
<div class="paragraph">
<p>具体启动方式参考 Spring Cloud Alibaba Nacos Discovery 小节的 "Nacos Server 启动" 章节。</p>
</div>
<div class="paragraph">
<p>Nacos Server 启动完毕后，添加如何配置:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Data ID:    nacos-config.properties

Group  :    DEFAULT_GROUP

配置格式:    Properties

配置内容：   user.name=nacos-config-properties
            user.age=90</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
注意DataId是以 properties(默认的文件扩展名方式)为扩展名。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_客户端使用方式">4.2.2. 客户端使用方式</h4>
<div class="paragraph">
<p>如果要在您的项目中使用 Nacos 来实现应用的外部化配置，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alibaba-nacos-config</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在创建一个标准的 Spring Boot 应用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class NacosConfigApplication {

    public static void main(String[] args) {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(ConfigApplication.class, args);
        String userName = applicationContext.getEnvironment().getProperty("user.name");
        String userAge = applicationContext.getEnvironment().getProperty("user.age");
        System.err.println("user name :"+userName+"; age: "+userAge);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在运行此 NacosConfigApplication 之前， 必须使用 <code>bootstrap.properties</code> 配置文件来配置 Nacos Server 地址，例如：</p>
</div>
<div class="listingblock">
<div class="title">bootstrap.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties"># DataId 默认使用 `spring.application.name` 配置跟文件扩展名结合(配置格式默认使用 properties), GROUP 不配置默认使用 DEFAULT_GROUP。因此该配置文件对应的 Nacos Config 配置的 DataId 为 nacos-config.properties, GROUP 为 DEFAULT_GROUP
spring.application.name=nacos-config
spring.cloud.nacos.config.server-addr=127.0.0.1:8848</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
注意当你使用域名的方式来访问 Nacos 时，<code>spring.cloud.nacos.config.server-addr</code> 配置的方式为 <code>域名:port</code>。
例如 Nacos 的域名为abc.com.nacos，监听的端口为 80，则 <code>spring.cloud.nacos.config.server-addr=abc.com.nacos:80</code>。
注意 80 端口不能省略。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>启动这个 Example，可以看到如下输出结果：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>2018-11-02 14:24:51.638  INFO 32700 --- [main] c.a.demo.provider.ConfigApplication    : Started ConfigApplication in 14.645 seconds (JVM running for 15.139)
user name :nacos-config-properties; age: 90
2018-11-02 14:24:51.688  INFO 32700 --- [-127.0.0.1:8848] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@a8c5e74: startup date [Fri Nov 02 14:24:51 CST 2018]; root of context hierarchy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_基于_dataid_为_yaml_的文件扩展名配置方式">4.3. 基于 DataId 为 yaml 的文件扩展名配置方式</h3>
<div class="paragraph">
<p>Nacos Config 除了支持 properties 格式以外，也支持 yaml 格式。这个时候只需要完成以下两步：</p>
</div>
<div class="paragraph">
<p>1、在应用的 bootstrap.properties 配置文件中显示的声明 DataId 文件扩展名。如下所示</p>
</div>
<div class="listingblock">
<div class="title">bootstrap.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring.cloud.nacos.config.file-extension=yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>2、在 Nacos 的控制台新增一个DataId为yaml为扩展名的配置，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Data ID:        nacos-config.yaml

Group  :        DEFAULT_GROUP

配置格式:        YAML

配置内容:        user.name: nacos-config-yaml
                user.age: 68</code></pre>
</div>
</div>
<div class="paragraph">
<p>这两步完成后，重启测试程序，可以看到如下输出结果。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>2018-11-02 14:59:00.484  INFO 32928 --- [main] c.a.demo.provider.ConfigApplication:Started ConfigApplication in 14.183 seconds (JVM running for 14.671)
user name :nacos-config-yaml; age: 68
2018-11-02 14:59:00.529  INFO 32928 --- [-127.0.0.1:8848] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@265a478e: startup date [Fri Nov 02 14:59:00 CST 2018]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_支持配置的动态更新">4.4. 支持配置的动态更新</h3>
<div class="paragraph">
<p>Nacos Config 默认支持配置的动态更新，启动 Spring Boot 应用测试的代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class ConfigApplication {

    public static void main(String[] args) {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(ConfigApplication.class, args);
        while(true) {
            //当动态配置刷新时，会更新到 Enviroment中，因此这里每隔一秒中从Enviroment中获取配置
            String userName = applicationContext.getEnvironment().getProperty("user.name");
            String userAge = applicationContext.getEnvironment().getProperty("user.age");
            System.err.println("user name :" + userName + "; age: " + userAge);
            TimeUnit.SECONDS.sleep(1);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如下所示，当变更user.name时，应用程序中能够获取到最新的值：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>user name :nacos-config-yaml; age: 68
user name :nacos-config-yaml; age: 68
user name :nacos-config-yaml; age: 68
2018-11-02 15:04:25.069  INFO 32957 --- [-127.0.0.1:8848] o.s.boot.SpringApplication               : Started application in 0.144 seconds (JVM running for 71.752)
2018-11-02 15:04:25.070  INFO 32957 --- [-127.0.0.1:8848] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@10c89124: startup date [Fri Nov 02 15:04:25 CST 2018]; parent: org.springframework.context.annotation.AnnotationConfigApplicationContext@6520af7
2018-11-02 15:04:25.071  INFO 32957 --- [-127.0.0.1:8848] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@6520af7: startup date [Fri Nov 02 15:04:24 CST 2018]; root of context hierarchy
//从 Enviroment 中 读取到更改后的值
user name :nacos-config-yaml-update; age: 68
user name :nacos-config-yaml-update; age: 68</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
你可以通过配置 <code>spring.cloud.nacos.config.refresh.enabled=false</code> 来关闭动态刷新
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_支持profile粒度的配置">4.5. 支持profile粒度的配置</h3>
<div class="paragraph">
<p>Nacos Config 在加载配置的时候，不仅仅加载了以 DataId 为 <code>${spring.application.name}.${file-extension:properties}</code>   为前缀的基础配置，还加载了DataId为 <code>${spring.application.name}-${profile}.${file-extension:properties}</code> 的基础配置。在日常开发中如果遇到多套环境下的不同配置，可以通过Spring 提供的 <code>${spring.profiles.active}</code> 这个配置项来配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.profiles.active=develop</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
${spring.profiles.active} 当通过配置文件来指定时必须放在 bootstrap.properties 文件中。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nacos 上新增一个DataId为：nacos-config-develop.yaml的基础配置，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Data ID:        nacos-config-develop.yaml

Group  :        DEFAULT_GROUP

配置格式:        YAML

配置内容:        current.env: develop-env</code></pre>
</div>
</div>
<div class="paragraph">
<p>启动 Spring Boot 应用测试的代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class ConfigApplication {

    public static void main(String[] args) {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(ConfigApplication.class, args);
        while(true) {
            String userName = applicationContext.getEnvironment().getProperty("user.name");
            String userAge = applicationContext.getEnvironment().getProperty("user.age");
            //获取当前部署的环境
            String currentEnv = applicationContext.getEnvironment().getProperty("current.env");
            System.err.println("in "+currentEnv+" enviroment; "+"user name :" + userName + "; age: " + userAge);
            TimeUnit.SECONDS.sleep(1);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>启动后，可见控制台的输出结果：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>in develop-env enviroment; user name :nacos-config-yaml-update; age: 68
2018-11-02 15:34:25.013  INFO 33014 --- [ Thread-11] ConfigServletWebServerApplicationContext : Closing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@6f1c29b7: startup date [Fri Nov 02 15:33:57 CST 2018]; parent: org.springframework.context.annotation.AnnotationConfigApplicationContext@63355449</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果需要切换到生产环境，只需要更改 <code>${spring.profiles.active}</code> 参数配置即可。如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.profiles.active=product</code></pre>
</div>
</div>
<div class="paragraph">
<p>同时生产环境上 Nacos 需要添加对应 DataId 的基础配置。例如，在生产环境下的 Naocs 添加了DataId为：nacos-config-product.yaml的配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Data ID:        nacos-config-product.yaml

Group  :        DEFAULT_GROUP

配置格式:        YAML

配置内容:        current.env: product-env</code></pre>
</div>
</div>
<div class="paragraph">
<p>启动测试程序，输出结果如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>in product-env enviroment; user name :nacos-config-yaml-update; age: 68
2018-11-02 15:42:14.628  INFO 33024 --- [Thread-11] ConfigServletWebServerApplicationContext : Closing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@6aa8e115: startup date [Fri Nov 02 15:42:03 CST 2018]; parent: org.springframework.context.annotation.AnnotationConfigApplicationContext@19bb07ed</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
此案例中我们通过 <code>spring.profiles.active=&lt;profilename&gt;</code> 的方式写死在配置文件中，而在真正的项目实施过程中这个变量的值是需要不同环境而有不同的值。这个时候通常的做法是通过 <code>-Dspring.profiles.active=&lt;profile&gt;</code> 参数指定其配置来达到环境间灵活的切换。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_支持自定义_namespace_的配置">4.6. 支持自定义 namespace 的配置</h3>
<div class="paragraph">
<p>Nacos 内部有 <a href="https://nacos.io/zh-cn/docs/concepts.html">Namespace 的概念</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。
</blockquote>
</div>
<div class="paragraph">
<p>在没有明确指定 <code>${spring.cloud.nacos.config.namespace}</code> 配置的情况下， 默认使用的是 Nacos 上 Public 这个namespace。如果需要使用自定义的命名空间，可以通过以下配置来实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.nacos.config.namespace=b3404bc0-d7dc-4855-b519-570ed34b62d7</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
该配置必须放在 bootstrap.properties 文件中。此外 <code>spring.cloud.nacos.config.namespace</code> 的值是 namespace 对应的 id，id 值可以在 Nacos 的控制台获取。并且在添加配置时注意不要选择其他的 namespae，否则将会导致读取不到正确的配置。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_支持自定义_group_的配置">4.7. 支持自定义 Group 的配置</h3>
<div class="paragraph">
<p>在没有明确指定 <code>${spring.cloud.nacos.config.group}</code> 配置的情况下， 默认使用的是 DEFAULT_GROUP 。如果需要自定义自己的 Group，可以通过以下配置来实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.nacos.config.group=DEVELOP_GROUP</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
该配置必须放在 bootstrap.properties 文件中。并且在添加配置时 Group 的值一定要和 <code>spring.cloud.nacos.config.group</code> 的配置值一致。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_支持自定义扩展的_data_id_配置">4.8. 支持自定义扩展的 Data Id 配置</h3>
<div class="paragraph">
<p>Nacos Config 从 0.2.1 版本后，可支持自定义 Data Id 的配置。关于这部分详细的设计可参考 <a href="https://github.com/alibaba/spring-cloud-alibaba/issues/141">这里</a>。
一个完整的配置案例如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.application.name=opensource-service-provider
spring.cloud.nacos.config.server-addr=127.0.0.1:8848

# config external configuration
# 1、Data Id 在默认的组 DEFAULT_GROUP,不支持配置的动态刷新
spring.cloud.nacos.config.ext-config[0].data-id=ext-config-common01.properties

# 2、Data Id 不在默认的组，不支持动态刷新
spring.cloud.nacos.config.ext-config[1].data-id=ext-config-common02.properties
spring.cloud.nacos.config.ext-config[1].group=GLOBALE_GROUP

# 3、Data Id 既不在默认的组，也支持动态刷新
spring.cloud.nacos.config.ext-config[2].data-id=ext-config-common03.properties
spring.cloud.nacos.config.ext-config[2].group=REFRESH_GROUP
spring.cloud.nacos.config.ext-config[2].refresh=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>通过 <code>spring.cloud.nacos.config.ext-config[n].data-id</code> 的配置方式来支持多个 Data Id 的配置。</p>
</li>
<li>
<p>通过 <code>spring.cloud.nacos.config.ext-config[n].group</code> 的配置方式自定义 Data Id 所在的组，不明确配置的话，默认是 DEFAULT_GROUP。</p>
</li>
<li>
<p>通过 <code>spring.cloud.nacos.config.ext-config[n].refresh</code> 的配置方式来控制该 Data Id 在配置变更时，是否支持应用中可动态刷新，
感知到最新的配置值。默认是不支持的。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
多个 Data Id 同时配置时，他的优先级关系是 <code>spring.cloud.nacos.config.ext-config[n].data-id</code> 其中 n 的值越大，优先级越高。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>spring.cloud.nacos.config.ext-config[n].data-id</code> 的值必须带文件扩展名，文件扩展名既可支持 properties，又可以支持 yaml/yml。
此时 <code>spring.cloud.nacos.config.file-extension</code> 的配置对自定义扩展配置的 Data Id 文件扩展名没有影响。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>通过自定义扩展的 Data Id 配置，既可以解决多个应用间配置共享的问题，又可以支持一个应用有多个配置文件。</p>
</div>
<div class="paragraph">
<p>为了更加清晰的在多个应用间配置共享的 Data Id ，你可以通过以下的方式来配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.nacos.config.shared-dataids=bootstrap-common.properties,all-common.properties
spring.cloud.nacos.config.refreshable-dataids=bootstrap-common.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>通过 <code>spring.cloud.nacos.config.shared-dataids</code> 来支持多个共享 Data Id 的配置，多个之间用逗号隔开。</p>
</li>
<li>
<p>通过 <code>spring.cloud.nacos.config.refreshable-dataids</code> 来支持哪些共享配置的 Data Id 在配置变化时，应用中是否可动态刷新，
感知到最新的配置值，多个 Data Id 之间用逗号隔开。如果没有明确配置，默认情况下所有共享配置的 Data Id 都不支持动态刷新。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
通过 <code>spring.cloud.nacos.config.shared-dataids</code> 来支持多个共享配置的 Data Id 时，
多个共享配置间的一个优先级的关系我们约定：按照配置出现的先后顺序，即后面的优先级要高于前面。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
通过 <code>spring.cloud.nacos.config.shared-dataids</code> 来配置时，Data Id 必须带文件扩展名，文件扩展名既可支持 properties，也可以支持 yaml/yml。
此时 <code>spring.cloud.nacos.config.file-extension</code> 的配置对自定义扩展配置的 Data Id 文件扩展名没有影响。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>spring.cloud.nacos.config.refreshable-dataids</code> 给出哪些需要支持动态刷新时，Data Id 的值也必须明确给出文件扩展名。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_配置的优先级">4.9. 配置的优先级</h3>
<div class="paragraph">
<p>Nacos Config 目前提供了三种配置能力从 Nacos 拉取相关的配置</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A: 通过 <code>spring.cloud.nacos.config.shared-dataids</code> 支持多个共享 Data Id 的配置</p>
</li>
<li>
<p>B: 通过 <code>spring.cloud.nacos.config.ext-config[n].data-id</code> 的方式支持多个扩展 Data Id 的配置</p>
</li>
<li>
<p>C: 通过内部相关规则(应用名、应用名+ Profile )自动生成相关的 Data Id 配置</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>若三种配置同时使用，优先级由高到低依次为: A -&#8594; B -&#8594; C</p>
</div>
</div>
<div class="sect2">
<h3 id="_nacos_config_对外暴露的_endpoint">4.10. Nacos Config 对外暴露的 Endpoint</h3>
<div class="paragraph">
<p>Nacos Config 内部提供了一个 Endpoint, 对应的 endpoint id 为 <code>nacos-config</code>。</p>
</div>
<div class="paragraph">
<p>Endpoint 暴露的 json 中包含了三种属性:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sources: 当前应用配置的数据信息</p>
</li>
<li>
<p>RefreshHistory: 配置刷新的历史记录</p>
</li>
<li>
<p>NacosConfigProperties: 当前应用 Nacos 的基础配置信息</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>这是 Endpoint 暴露的 json 示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
	"NacosConfigProperties": {
		"serverAddr": "127.0.0.1:8848",
		"encode": null,
		"group": "DEFAULT_GROUP",
		"prefix": null,
		"fileExtension": "properties",
		"timeout": 3000,
		"endpoint": null,
		"namespace": null,
		"accessKey": null,
		"secretKey": null,
		"contextPath": null,
		"clusterName": null,
		"name": null,
		"sharedDataids": "base-common.properties,common.properties",
		"refreshableDataids": "common.properties",
		"extConfig": null
	},
	"RefreshHistory": [{
		"timestamp": "2019-07-29 11:20:04",
		"dataId": "nacos-config-example.properties",
		"md5": "7d5d7f1051ff6571e2ec9f90887d9d91"
	}],
	"Sources": [{
		"lastSynced": "2019-07-29 11:19:04",
		"dataId": "common.properties"
	}, {
		"lastSynced": "2019-07-29 11:19:04",
		"dataId": "base-common.properties"
	}, {
		"lastSynced": "2019-07-29 11:19:04",
		"dataId": "nacos-config-example.properties"
	}]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_完全关闭_nacos_config_的自动化配置">4.11. 完全关闭 Nacos Config 的自动化配置</h3>
<div class="paragraph">
<p>通过设置 <code>spring.cloud.nacos.config.enabled = false</code> 来完全关闭 <code>Spring Cloud Nacos Config</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_关于_nacos_config_starter_更多的配置项信息">4.12. 关于 Nacos Config Starter 更多的配置项信息</h3>
<div class="paragraph">
<p>更多关于 <code>Nacos Config Starter</code> 的配置项如下所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">说明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务端地址</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.server-addr</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nacos Server 启动监听的ip地址和端口</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置对应的 DataId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.name</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先取 prefix，再取 name，最后取 spring.application.name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置对应的 DataId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.prefix</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">先取 prefix，再取 name，最后取 spring.application.name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置内容编码</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.encode</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">读取的配置内容对应的编码</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GROUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT_GROUP</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置对应的组</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">文件扩展名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.fileExtension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>properties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项对应的文件扩展名，目前支持 properties 和 yaml(yml)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">获取配置超时时间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">客户端获取配置的超时时间(毫秒)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">接入点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">地域的某个服务的入口域名，通过此域名可以动态地拿到服务端地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">命名空间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.namespace</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AccessKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.accessKey</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当要上阿里云时，阿里云上面的一个云账号名</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecretKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.secretKey</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当要上阿里云时，阿里云上面的一个云账号密码</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nacos Server 对应的 context path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.contextPath</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nacos Server 对外暴露的 context path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.clusterName</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置成Nacos集群名称</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">共享配置</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.sharedDataids</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">共享配置的 DataId, "," 分割</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">共享配置动态刷新</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.refreshableDataids</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">共享配置中需要动态刷新的 DataId, "," 分割</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">自定义 Data Id 配置</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.nacos.config.extConfig</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">属性是个集合，内部由 <code>Config</code> POJO 组成。<code>Config</code> 有 3 个属性，分别是 <code>dataId</code>, <code>group</code> 以及 <code>refresh</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_sentinel">5. Spring Cloud Alibaba Sentinel</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_sentinel_介绍">5.1. Sentinel 介绍</h3>
<div class="paragraph">
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。 <a href="https://github.com/alibaba/Sentinel">Sentinel</a> 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/alibaba/Sentinel">Sentinel</a> 具有以下特征:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>丰富的应用场景</strong>： Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、实时熔断下游不可用应用等。</p>
</li>
<li>
<p><strong>完备的实时监控</strong>： Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p>
</li>
<li>
<p><strong>广泛的开源生态</strong>： Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p>
</li>
<li>
<p><strong>完善的 SPI 扩展点</strong>： Sentinel 提供简单易用、完善的 SPI 扩展点。您可以通过实现扩展点，快速的定制逻辑。例如定制规则管理、适配数据源等。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用_sentinel">5.2. 如何使用 Sentinel</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 Sentinel，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alibaba-sentinel</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">[source,yaml]
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>下面这个例子就是一个最简单的使用 Sentinel 的例子:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(ServiceApplication.class, args);
    }

}

@RestController
public class TestController {

    @GetMapping(value = "/hello")
    @SentinelResource("hello")
    public String hello() {
        return "Hello Sentinel";
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>@SentinelResource 注解用来标识资源是否被限流、降级。上述例子上该注解的属性 'hello' 表示资源名。</p>
</div>
<div class="paragraph">
<p>@SentinelResource 还提供了其它额外的属性如 <code>blockHandler</code>，<code>blockHandlerClass</code>，<code>fallback</code> 用于表示限流或降级的操作，更多内容可以参考 <a href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">Sentinel注解支持</a>。</p>
</div>
<div class="paragraph">
<p>以上例子都是在 WebServlet 环境下使用的，Sentinel 目前已经支持 WebFlux，需要配合 <code>spring-boot-starter-webflux</code> 依赖触发 sentinel-starter 中 WebFlux 相关的自动化配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(ServiceApplication.class, args);
    }

}

@RestController
public class TestController {

    @GetMapping("/mono")
    @SentinelResource("hello")
    public Mono&lt;String&gt; mono() {
	return Mono.just("simple string")
			.transform(new SentinelReactorTransformer&lt;&gt;("otherResourceName"));
    }

}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_sentinel_控制台">Sentinel 控制台</h5>
<div class="paragraph">
<p>Sentinel 控制台提供一个轻量级的控制台，它提供机器发现、单机资源实时监控、集群资源汇总，以及规则管理的功能。您只需要对应用进行简单的配置，就可以使用这些功能。</p>
</div>
<div class="paragraph">
<p><strong>注意</strong>: 集群资源汇总仅支持 500 台以下的应用集群，有大概 1 - 2 秒的延时。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/alibaba/Sentinel/wiki/image/dashboard.png" alt="dashboard">
</div>
<div class="title">Figure 3. Sentinel Dashboard</div>
</div>
<div class="paragraph">
<p>开启该功能需要3个步骤：</p>
</div>
<div class="sect5">
<h6 id="_获取控制台">获取控制台</h6>
<div class="paragraph">
<p>您可以从 <a href="https://github.com/alibaba/Sentinel/releases">release 页面</a> 下载最新版本的控制台 jar 包。</p>
</div>
<div class="paragraph">
<p>您也可以从最新版本的源码自行构建 Sentinel 控制台：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>下载 <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-dashboard">控制台</a> 工程</p>
</li>
<li>
<p>使用以下命令将代码打包成一个 fat jar: <code>mvn clean package</code></p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_启动控制台">启动控制台</h6>
<div class="paragraph">
<p>Sentinel 控制台是一个标准的 SpringBoot 应用，以 SpringBoot 的方式运行 jar 包即可。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="shell">java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>如若8080端口冲突，可使用 <code>-Dserver.port=新端口</code> 进行设置。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置控制台信息">5.2.2. 配置控制台信息</h4>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>spring:
  cloud:
    sentinel:
      transport:
        port: 8719
        dashboard: localhost:8080</pre>
</div>
</div>
<div class="paragraph">
<p>这里的 <code>spring.cloud.sentinel.transport.port</code> 端口配置会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互。比如 Sentinel 控制台添加了1个限流规则，会把规则数据 push 给这个 Http Server 接收，Http Server 再将规则注册到 Sentinel 中。</p>
</div>
<div class="paragraph">
<p>更多 Sentinel 控制台的使用及问题参考： <a href="https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0">Sentinel控制台</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openfeign_支持">5.3. OpenFeign 支持</h3>
<div class="paragraph">
<p>Sentinel 适配了 <a href="https://github.com/OpenFeign/feign">OpenFeign</a> 组件。如果想使用，除了引入 <code>sentinel-starter</code> 的依赖外还需要 2 个步骤：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>配置文件打开 sentinel 对 feign 的支持：<code>feign.sentinel.enabled=true</code></p>
</li>
<li>
<p>加入 <code>openfeign starter</code> 依赖使 <code>sentinel starter</code> 中的自动化配置类生效：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>这是一个 <code>FeignClient</code> 的简单使用示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@FeignClient(name = "service-provider", fallback = EchoServiceFallback.class, configuration = FeignConfiguration.class)
public interface EchoService {
    @GetMapping(value = "/echo/{str}")
    String echo(@PathVariable("str") String str);
}

class FeignConfiguration {
    @Bean
    public EchoServiceFallback echoServiceFallback() {
        return new EchoServiceFallback();
    }
}

class EchoServiceFallback implements EchoService {
    @Override
    public String echo(@PathVariable("str") String str) {
        return "echo fallback";
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Feign 对应的接口中的资源名策略定义：httpmethod:protocol://requesturl。<code>@FeignClient</code> 注解中的所有属性，Sentinel 都做了兼容。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>EchoService</code> 接口中方法 <code>echo</code> 对应的资源名为 <code>GET:http://service-provider/echo/{str}</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_resttemplate_支持">5.4. RestTemplate 支持</h3>
<div class="paragraph">
<p>Spring Cloud Alibaba Sentinel 支持对 <code>RestTemplate</code> 的服务调用使用 Sentinel 进行保护，在构造 <code>RestTemplate</code> bean的时候需要加上 <code>@SentinelRestTemplate</code> 注解。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Bean
@SentinelRestTemplate(blockHandler = "handleException", blockHandlerClass = ExceptionUtil.class)
public RestTemplate restTemplate() {
    return new RestTemplate();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@SentinelRestTemplate</code> 注解的属性支持限流(<code>blockHandler</code>, <code>blockHandlerClass</code>)和降级(<code>fallback</code>, <code>fallbackClass</code>)的处理。</p>
</div>
<div class="paragraph">
<p>其中 <code>blockHandler</code> 或 <code>fallback</code> 属性对应的方法必须是对应 <code>blockHandlerClass</code> 或 <code>fallbackClass</code> 属性中的静态方法。</p>
</div>
<div class="paragraph">
<p>该方法的参数跟返回值跟 <code>org.springframework.http.client.ClientHttpRequestInterceptor#interceptor</code> 方法一致，其中参数多出了一个 <code>BlockException</code> 参数用于获取 Sentinel 捕获的异常。</p>
</div>
<div class="paragraph">
<p>比如上述 <code>@SentinelRestTemplate</code> 注解中 <code>ExceptionUtil</code> 的 <code>handleException</code> 属性对应的方法声明如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class ExceptionUtil {
    public static ClientHttpResponse handleException(HttpRequest request, byte[] body, ClientHttpRequestExecution execution, BlockException exception) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
应用启动的时候会检查 <code>@SentinelRestTemplate</code> 注解对应的限流或降级方法是否存在，如不存在会抛出异常
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>@SentinelRestTemplate</code> 注解的限流(<code>blockHandler</code>, <code>blockHandlerClass</code>)和降级(<code>fallback</code>, <code>fallbackClass</code>)属性不强制填写。</p>
</div>
<div class="paragraph">
<p>当使用 <code>RestTemplate</code> 调用被 Sentinel 熔断后，会返回 <code>RestTemplate request block by sentinel</code> 信息，或者也可以编写对应的方法自行处理返回信息。这里提供了 <code>SentinelClientHttpResponse</code> 用于构造返回信息。</p>
</div>
<div class="paragraph">
<p>Sentinel RestTemplate 限流的资源规则提供两种粒度：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>httpmethod:schema://host:port/path</code>：协议、主机、端口和路径</p>
</li>
<li>
<p><code>httpmethod:schema://host:port</code>：协议、主机和端口</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
以 <code><a href="https://www.taobao.com/test" class="bare">https://www.taobao.com/test</a></code> 这个 url 并使用 GET 方法为例。对应的资源名有两种粒度，分别是 <code>GET:https://www.taobao.com</code> 以及 <code>GET:https://www.taobao.com/test</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_动态数据源支持">5.5. 动态数据源支持</h3>
<div class="paragraph">
<p><code>SentinelProperties</code> 内部提供了 <code>TreeMap</code> 类型的 <code>datasource</code> 属性用于配置数据源信息。</p>
</div>
<div class="paragraph">
<p>比如配置 4 个数据源：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.sentinel.datasource.ds1.file.file=classpath: degraderule.json
spring.cloud.sentinel.datasource.ds1.file.rule-type=flow

#spring.cloud.sentinel.datasource.ds1.file.file=classpath: flowrule.json
#spring.cloud.sentinel.datasource.ds1.file.data-type=custom
#spring.cloud.sentinel.datasource.ds1.file.converter-class=org.springframework.cloud.alibaba.cloud.examples.JsonFlowRuleListConverter
#spring.cloud.sentinel.datasource.ds1.file.rule-type=flow

spring.cloud.sentinel.datasource.ds2.nacos.server-addr=localhost:8848
spring.cloud.sentinel.datasource.ds2.nacos.data-id=sentinel
spring.cloud.sentinel.datasource.ds2.nacos.group-id=DEFAULT_GROUP
spring.cloud.sentinel.datasource.ds2.nacos.data-type=json
spring.cloud.sentinel.datasource.ds2.nacos.rule-type=degrade

spring.cloud.sentinel.datasource.ds3.zk.path = /Sentinel-Demo/SYSTEM-CODE-DEMO-FLOW
spring.cloud.sentinel.datasource.ds3.zk.server-addr = localhost:2181
spring.cloud.sentinel.datasource.ds3.zk.rule-type=authority

spring.cloud.sentinel.datasource.ds4.apollo.namespace-name = application
spring.cloud.sentinel.datasource.ds4.apollo.flow-rules-key = sentinel
spring.cloud.sentinel.datasource.ds4.apollo.default-flow-rule-value = test
spring.cloud.sentinel.datasource.ds4.apollo.rule-type=param-flow</code></pre>
</div>
</div>
<div class="paragraph">
<p>这种配置方式参考了 Spring Cloud Stream Binder 的配置，内部使用了 <code>TreeMap</code> 进行存储，comparator 为 <code>String.CASE_INSENSITIVE_ORDER</code> 。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
d1, ds2, ds3, ds4 是 <code>ReadableDataSource</code> 的名字，可随意编写。后面的 <code>file</code> ，<code>zk</code> ，<code>nacos</code> , <code>apollo</code> 就是对应具体的数据源。 它们后面的配置就是这些具体数据源各自的配置。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>每种数据源都有两个共同的配置项： <code>data-type</code>、 <code>converter-class</code> 以及 <code>rule-type</code>。</p>
</div>
<div class="paragraph">
<p><code>data-type</code> 配置项表示 <code>Converter</code> 类型，Spring Cloud Alibaba Sentinel 默认提供两种内置的值，分别是 <code>json</code> 和 <code>xml</code> (不填默认是json)。 如果不想使用内置的 <code>json</code> 或 <code>xml</code> 这两种 <code>Converter</code>，可以填写 <code>custom</code> 表示自定义 <code>Converter</code>，然后再配置 <code>converter-class</code> 配置项，该配置项需要写类的全路径名(比如 <code>spring.cloud.sentinel.datasource.ds1.file.converter-class=org.springframework.cloud.alibaba.cloud.examples.JsonFlowRuleListConverter</code>)。</p>
</div>
<div class="paragraph">
<p><code>rule-type</code> 配置表示该数据源中的规则属于哪种类型的规则(<code>flow</code>，<code>degrade</code>，<code>authority</code>，<code>system</code>, <code>param-flow</code>, <code>gw-flow</code>, <code>gw-api-group</code>)。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
当某个数据源规则信息加载失败的情况下，不会影响应用的启动，会在日志中打印出错误信息。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
默认情况下，xml 格式是不支持的。需要添加 <code>jackson-dataformat-xml</code> 依赖后才会自动生效。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>关于 Sentinel 动态数据源的实现原理，参考： <a href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">动态规则扩展</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_zuul_支持">5.6. Zuul 支持</h3>
<div class="paragraph">
<p><a href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">参考 Sentinel 网关限流</a></p>
</div>
<div class="paragraph">
<p>若想跟 Sentinel Starter 配合使用，需要加上 <code>spring-cloud-alibaba-sentinel-gateway</code> 依赖，同时需要添加 <code>spring-cloud-starter-netflix-zuul</code> 依赖来让 <code>spring-cloud-alibaba-sentinel-gateway</code> 模块里的 Zuul 自动化配置类生效：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_cloud_gateway_支持">5.7. Spring Cloud Gateway 支持</h3>
<div class="paragraph">
<p><a href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">参考 Sentinel 网关限流</a></p>
</div>
<div class="paragraph">
<p>若想跟 Sentinel Starter 配合使用，需要加上 <code>spring-cloud-alibaba-sentinel-gateway</code> 依赖，同时需要添加 <code>spring-cloud-starter-gateway</code> 依赖来让 <code>spring-cloud-alibaba-sentinel-gateway</code> 模块里的 Spring Cloud Gateway 自动化配置类生效：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sentinel_对外暴露的_endpoint">5.8. Sentinel 对外暴露的 Endpoint</h3>
<div class="paragraph">
<p>Sentinel 内部提供了一个 Endpoint, 对应的 endpoint id 为 <code>sentinel</code>。</p>
</div>
<div class="paragraph">
<p>Endpoint 暴露的 json 中包含了多种属性:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>appName: 应用名</p>
</li>
<li>
<p>logDir: 日志所在目录</p>
</li>
<li>
<p>logUsePid: 日志文件名是否带上进程id</p>
</li>
<li>
<p>blockPage: 限流 block 之后跳转的页面</p>
</li>
<li>
<p>metricsFileSize: metrics 文件的大小</p>
</li>
<li>
<p>metricsFileCharset: metrics 文件对应的字符集</p>
</li>
<li>
<p>totalMetricsFileCount: metrics 最多保留的文件数</p>
</li>
<li>
<p>consoleServer: sentinel dashboard 地址</p>
</li>
<li>
<p>clientIp: 客户端 ip</p>
</li>
<li>
<p>heartbeatIntervalMs: 客户端跟 dashboard 的心跳间隔时间</p>
</li>
<li>
<p>clientPort: 客户端需要暴露的端口跟 dashboard 进行交互</p>
</li>
<li>
<p>coldFactor: 冷启动因子</p>
</li>
<li>
<p>filter: CommonFilter 相关的属性， 比如 order, urlPatterns 以及 enable</p>
</li>
<li>
<p>datasource: 客户端配置的数据源信息</p>
</li>
<li>
<p>rules: 客户端生效的规则，内部含有 flowRules, degradeRules, systemRules, authorityRule, paramFlowRule</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>这是 Endpoint 暴露的 json 示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
	"blockPage": null,
	"appName": "sentinel-example",
	"consoleServer": "localhost:8080",
	"coldFactor": "3",
	"rules": {
		"flowRules": [{
			"resource": "GET:http://www.taobao.com",
			"limitApp": "default",
			"grade": 1,
			"count": 0.0,
			"strategy": 0,
			"refResource": null,
			"controlBehavior": 0,
			"warmUpPeriodSec": 10,
			"maxQueueingTimeMs": 500,
			"clusterMode": false,
			"clusterConfig": null
		}, {
			"resource": "/test",
			"limitApp": "default",
			"grade": 1,
			"count": 0.0,
			"strategy": 0,
			"refResource": null,
			"controlBehavior": 0,
			"warmUpPeriodSec": 10,
			"maxQueueingTimeMs": 500,
			"clusterMode": false,
			"clusterConfig": null
		}, {
			"resource": "/hello",
			"limitApp": "default",
			"grade": 1,
			"count": 1.0,
			"strategy": 0,
			"refResource": null,
			"controlBehavior": 0,
			"warmUpPeriodSec": 10,
			"maxQueueingTimeMs": 500,
			"clusterMode": false,
			"clusterConfig": null
		}]
	},
	"metricsFileCharset": "UTF-8",
	"filter": {
		"order": -2147483648,
		"urlPatterns": ["/*"],
		"enabled": true
	},
	"totalMetricsFileCount": 6,
	"datasource": {
		"ds1": {
			"file": {
				"dataType": "json",
				"ruleType": "FLOW",
				"converterClass": null,
				"file": "...",
				"charset": "utf-8",
				"recommendRefreshMs": 3000,
				"bufSize": 1048576
			},
			"nacos": null,
			"zk": null,
			"apollo": null,
			"redis": null
		}
	},
	"clientIp": "30.5.121.91",
	"clientPort": "8719",
	"logUsePid": false,
	"metricsFileSize": 52428800,
	"logDir": "...",
	"heartbeatIntervalMs": 10000
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_关于_sentinel_starter_更多的配置项信息">5.9. 关于 Sentinel Starter 更多的配置项信息</h3>
<div class="paragraph">
<p>下表显示当应用的 <code>ApplicationContext</code> 中存在对应的Bean的类型时，会进行自动化设置：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">存在Bean的类型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">操作</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">作用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UrlCleaner</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WebCallbackManager.setUrlCleaner(urlCleaner)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">资源清理(资源（比如将满足 /foo/:id 的 URL 都归到 /foo/* 资源下）)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UrlBlockHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WebCallbackManager.setUrlBlockHandler(urlBlockHandler)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">自定义限流处理逻辑</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RequestOriginParser</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WebCallbackManager.setRequestOriginParser(requestOriginParser)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置来源信息</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring Cloud Alibaba Sentinel 提供了这些配置选项</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">含义</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.application.name</code> or <code>project.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel项目名</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel自动化配置是否生效</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.eager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否提前触发 Sentinel 初始化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.transport.port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用的HttpServer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8719</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.transport.dashboard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel 控制台地址</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.transport.heartbeat-interval-ms</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用与Sentinel控制台的心跳间隔时间</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.transport.client-ip</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">此配置的客户端IP将被注册到 Sentinel Server 端</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.filter.order</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servlet Filter的加载顺序。Starter内部会构造这个filter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer.MIN_VALUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.filter.url-patterns</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据类型是数组。表示Servlet Filter的url pattern集合</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.filter.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable to instance CommonFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.metric.charset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metric文件字符集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.metric.file-single-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel metric 单个文件的大小</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.metric.file-total-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel metric 总文件数量</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.log.dir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel 日志文件所在的目录</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.log.switch-pid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sentinel 日志文件名是否需要带上pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.servlet.block-page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">自定义的跳转 URL，当请求被限流时会自动跳转至设定好的 URL</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.flow.cold-factor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---" class="bare">https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---</a>
%E5%86%B7%E5%90%AF%E5%8A%A8[冷启动因子]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.zuul.order.pre</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SentinelZuulPreFilter 的 order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.zuul.order.post</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SentinelZuulPostFilter 的 order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.zuul.order.error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SentinelZuulErrorFilter 的 order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.scg.fallback.mode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Cloud Gateway 熔断后的响应模式(选择 <code>redirect</code> or <code>response</code>)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.scg.fallback.redirect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Cloud Gateway 响应模式为 'redirect' 模式对应的重定向 URL</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.scg.fallback.response-body</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Cloud Gateway 响应模式为 'response' 模式对应的响应内容</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.scg.fallback.response-status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Cloud Gateway 响应模式为 'response' 模式对应的响应码</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.sentinel.scg.fallback.content-type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Cloud Gateway 响应模式为 'response' 模式对应的 content-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/json</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
请注意。这些配置只有在 Servlet 环境下才会生效，RestTemplate 和 Feign 针对这些配置都无法生效
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_rocketmq_binder">6. Spring Cloud Alibaba RocketMQ Binder</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rocketmq_介绍">6.1. RocketMQ 介绍</h3>
<div class="paragraph">
<p><a href="https://rocketmq.apache.org">RocketMQ</a> 是一款开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务。同时，广泛应用于多个领域，包括异步通信解耦、企业解决方案、金融支付、电信、电子商务、快递物流、广告营销、社交、即时通信、移动应用、手游、视频、物联网、车联网等。</p>
</div>
<div class="paragraph">
<p>具有以下特点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>能够保证严格的消息顺序</p>
</li>
<li>
<p>提供丰富的消息拉取模式</p>
</li>
<li>
<p>高效的订阅者水平扩展能力</p>
</li>
<li>
<p>实时的消息订阅机制</p>
</li>
<li>
<p>亿级消息堆积能力</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rocketmq_基本使用">6.2. RocketMQ 基本使用</h3>
<div class="ulist">
<ul>
<li>
<p>下载 RocketMQ</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下载 <a href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.3.2/rocketmq-all-4.3.2-bin-release.zip">RocketMQ最新的二进制文件</a>，并解压</p>
</div>
<div class="paragraph">
<p>解压后的目录结构如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>apache-rocketmq
├── LICENSE
├── NOTICE
├── README.md
├── benchmark
├── bin
├── conf
└── lib</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>启动 NameServer</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">nohup sh bin/mqnamesrv &amp;
tail -f ~/logs/rocketmqlogs/namesrv.log</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>启动 Broker</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">nohup sh bin/mqbroker -n localhost:9876 &amp;
tail -f ~/logs/rocketmqlogs/broker.log</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>发送、接收消息</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>发送消息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</code></pre>
</div>
</div>
<div class="paragraph">
<p>发送成功后显示：<code>SendResult [sendStatus=SEND_OK, msgId= &#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>接收消息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</code></pre>
</div>
</div>
<div class="paragraph">
<p>接收成功后显示：<code>ConsumeMessageThread_%d Receive New Messages: [MessageExt&#8230;&#8203;</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>关闭 Server</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">sh bin/mqshutdown broker
sh bin/mqshutdown namesrv</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_cloud_stream_介绍">6.3. Spring Cloud Stream 介绍</h3>
<div class="paragraph">
<p>Spring Cloud Stream 是一个用于构建基于消息的微服务应用框架。它基于 SpringBoot 来创建具有生产级别的单机 Spring 应用，并且使用 <code>Spring Integration</code> 与 Broker 进行连接。</p>
</div>
<div class="paragraph">
<p>Spring Cloud Stream 提供了消息中间件配置的统一抽象，推出了 publish-subscribe、consumer groups、partition 这些统一的概念。</p>
</div>
<div class="paragraph">
<p>Spring Cloud Stream 内部有两个概念：Binder 和 Binding。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Binder: 跟外部消息中间件集成的组件，用来创建 Binding，各消息中间件都有自己的 Binder 实现。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>比如 <code>Kafka</code> 的实现 <code>KafkaMessageChannelBinder</code>，<code>RabbitMQ</code> 的实现 <code>RabbitMessageChannelBinder</code> 以及 <code>RocketMQ</code> 的实现 <code>RocketMQMessageChannelBinder</code>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Binding: 包括 Input Binding 和 Output Binding。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Binding 在消息中间件与应用程序提供的 Provider 和 Consumer 之间提供了一个桥梁，实现了开发者只需使用应用程序的 Provider 或 Consumer 生产或消费数据即可，屏蔽了开发者与底层消息中间件的接触。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://docs.spring.io/spring-cloud-stream/docs/current/reference/htmlsingle/images/SCSt-overview.png" alt="SCSt overview">
</div>
<div class="title">Figure 4. Spring Cloud Stream</div>
</div>
<div class="paragraph">
<p>使用 Spring Cloud Stream 完成一段简单的消息发送和消息接收代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">MessageChannel messageChannel = new DirectChannel();

// 消息订阅
((SubscribableChannel) messageChannel).subscribe(new MessageHandler() {
    @Override
    public void handleMessage(Message&lt;?&gt; message) throws MessagingException {
        System.out.println("receive msg: " + message.getPayload());
    }
});

// 消息发送
messageChannel.send(MessageBuilder.withPayload("simple msg").build());</code></pre>
</div>
</div>
<div class="paragraph">
<p>这段代码所有的消息类都是 <code>spring-messaging</code> 模块里提供的。屏蔽具体消息中间件的底层实现，如果想用更换消息中间件，在配置文件里配置相关消息中间件信息以及修改 binder 依赖即可。</p>
</div>
<div class="paragraph">
<p><strong>Spring Cloud Stream 底层基于这段代码去做了各种抽象。</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用_spring_cloud_alibaba_rocketmq_binder">6.4. 如何使用 Spring Cloud Alibaba RocketMQ Binder</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 RocketMQ Binder，需要引入如下 maven 依赖：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-stream-binder-rocketmq&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>或者可以使用 Spring Cloud Stream RocketMQ Starter：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-stream-rocketmq&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_cloud_alibaba_rocketmq_binder_实现">6.5. Spring Cloud Alibaba RocketMQ Binder 实现</h3>
<div class="paragraph">
<p>这是 Spring Cloud Stream RocketMQ Binder 的实现架构:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://img.alicdn.com/tfs/TB1v8rcbUY1gK0jSZFCXXcwqXXa-1236-773.png" alt="TB1v8rcbUY1gK0jSZFCXXcwqXXa 1236 773">
</div>
<div class="title">Figure 5. SCS RocketMQ Binder</div>
</div>
<div class="paragraph">
<p>RocketMQ Binder 的重构优化去除了对 <a href="https://github.com/apache/rocketmq-spring">RocketMQ-Spring</a>框架的依赖 。
RocketMQ Binder 核心类 <code>RocketMQMessageChannelBinder</code> 实现了 Spring Cloud Stream 规范，内部会构建 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/integration/inbound/RocketMQInboundChannelAdapter.java">RocketMQInboundChannelAdapter</a> 和 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/integration/outbound/RocketMQProducerMessageHandler.java">RocketMQProducerMessageHandler</a>。</p>
</div>
<div class="paragraph">
<p><code>RocketMQProducerMessageHandler</code> 会基于 Binding 配置通过 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/integration/outbound/RocketMQProduceFactory.java">RocketMQProduceFactory</a>构造 RocketMQ Producer，其内部会把 <code>spring-messaging</code> 模块内 <code>org.springframework.messaging.Message</code> 消息类转换成 RocketMQ 的消息类 <code>org.apache.rocketmq.common.message.Message</code>，然后发送出去。</p>
</div>
<div class="paragraph">
<p><code>RocketMQInboundChannelAdapter</code> 也会基于 Binding 配置通过 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/integration/inbound/RocketMQConsumerFactory.java">RocketMQConsumerFactory</a>构造 DefaultMQPushConsumer，其内部会启动 RocketMQ Consumer 接收消息。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
与 <a href="https://github.com/apache/rocketmq-spring">RocketMQ-Spring</a> 框架的兼容需要手动处理
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>目前 Binder 支持在 <code>Header</code> 中设置相关的 key 来进行 RocketMQ Message 消息的特性设置。</p>
</div>
<div class="paragraph">
<p>比如 <code>TAGS</code>、<code>KEYS</code>、<code>TRANSACTIONAL_ARGS</code> 等 RocketMQ 消息对应的标签，详情见 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/contants/RocketMQConst.java">com.alibaba.cloud.stream.binder.rocketmq.constant.RocketMQConst</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">MessageBuilder builder = MessageBuilder.withPayload(msg)
    .setHeader(RocketMQHeaders.TAGS, "binder")
    .setHeader(RocketMQHeaders.KEYS, "my-key");
Message message = builder.build();
output().send(message);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
更多使用请参考样例: <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-examples/rocketmq-example/rocketmq-produce-example/src/main/java/com/alibaba/cloud/examples/SenderService.java">com.alibaba.cloud.examples.SenderService</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_messagesource_支持">6.6. MessageSource 支持</h3>
<div class="paragraph">
<p>SCS RocketMQ Binder 支持 <code>MessageSource</code>，可以进行消息的拉取，例子如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
@EnableBinding(MQApplication.PolledProcessor.class)
public class MQApplication {

  private final Logger logger =
  	  LoggerFactory.getLogger(MQApplication.class);

  public static void main(String[] args) {
    SpringApplication.run(MQApplication.class, args);
  }

  @Bean
  public ApplicationRunner runner(PollableMessageSource source,
  	    MessageChannel dest) {
    return args -&gt; {
      while (true) {
        boolean result = source.poll(m -&gt; {
          String payload = (String) m.getPayload();
          logger.info("Received: " + payload);
          dest.send(MessageBuilder.withPayload(payload.toUpperCase())
              .copyHeaders(m.getHeaders())
              .build());
        }, new ParameterizedTypeReference&lt;String&gt;() { });
        if (result) {
          logger.info("Processed a message");
        }
        else {
          logger.info("Nothing to do");
        }
        Thread.sleep(5_000);
      }
    };
  }

  public static interface PolledProcessor {

    @Input
    PollableMessageSource source();

    @Output
    MessageChannel dest();

  }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置选项">6.7. 配置选项</h3>
<div class="sect3">
<h4 id="_rocketmq_binder_properties">6.7.1. RocketMQ Binder Properties</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">spring.cloud.stream.rocketmq.binder.name-server</dt>
<dd>
<p>RocketMQ NameServer 地址(老版本使用 namesrv-addr 配置项)。</p>
<div class="paragraph">
<p>Default: <code>127.0.0.1:9876</code>.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.rocketmq.binder.access-key</dt>
<dd>
<p>阿里云账号 AccessKey。</p>
<div class="paragraph">
<p>Default: null.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.rocketmq.binder.secret-key</dt>
<dd>
<p>阿里云账号 SecretKey。</p>
<div class="paragraph">
<p>Default: null.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.rocketmq.binder.enable-msg-trace</dt>
<dd>
<p>是否为 Producer 和 Consumer 开启消息轨迹功能</p>
<div class="paragraph">
<p>Default: <code>true</code>.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.rocketmq.binder.customized-trace-topic</dt>
<dd>
<p>消息轨迹开启后存储的 topic 名称。</p>
<div class="paragraph">
<p>Default: <code>RMQ_SYS_TRACE_TOPIC</code>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_rocketmq_consumer_properties">6.7.2. RocketMQ Consumer Properties</h4>
<div class="paragraph">
<p>下面的这些配置是以 <code>spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.consumer.</code> 为前缀的 RocketMQ Consumer 相关的配置。
更多见 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/properties/RocketMQConsumerProperties.java">com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQConsumerProperties</a>。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">enable</dt>
<dd>
<p>是否启用 Consumer。</p>
<div class="paragraph">
<p>默认值: <code>true</code>.</p>
</div>
</dd>
<dt class="hdlist1">subscription</dt>
<dd>
<p>Consumer 基于 TAGS 订阅，多个 tag 以 <code>||</code> 分割。更多见 <code>com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQConsumerProperties.subscription</code></p>
<div class="paragraph">
<p>默认值: empty.</p>
</div>
</dd>
<dt class="hdlist1">messageModel</dt>
<dd>
<p>Consumer 消费模式。如果想让每一个的订阅者都能接收到消息，可以使用广播模式。更多见 <code>org.apache.rocketmq.common.protocol.heartbeat.MessageModel</code></p>
<div class="paragraph">
<p>默认值: <code>CLUSTERING</code>.</p>
</div>
</dd>
<dt class="hdlist1">consumeFromWhere</dt>
<dd>
<p>Consumer 从哪里开始消费。更多见 <code>org.apache.rocketmq.common.consumer.ConsumeFromWhere</code></p>
<div class="paragraph">
<p>默认值: <code>CONSUME_FROM_LAST_OFFSET</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><mark>下面的这些配置是 Consumer Push 模式相关的配置。</mark>
 <code>spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.consumer.push.</code></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">orderly</dt>
<dd>
<p>是否同步消费消息模式</p>
<div class="paragraph">
<p>默认值: <code>false</code>.</p>
</div>
</dd>
<dt class="hdlist1">delayLevelWhenNextConsume</dt>
<dd>
<p>异步消费消息模式下消费失败重试策略：</p>
<div class="ulist">
<ul>
<li>
<p>-1,不重复，直接放入死信队列</p>
</li>
<li>
<p>0,broker 控制重试策略</p>
</li>
<li>
<p>&gt;0,client 控制重试策略</p>
<div class="paragraph">
<p>默认值: <code>0</code>.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">suspendCurrentQueueTimeMillis</dt>
<dd>
<p>同步消费消息模式下消费失败后再次消费的时间间隔。</p>
<div class="paragraph">
<p>默认值: <code>1000</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>其他更多参数见 <code>com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQConsumerProperties.Push</code></p>
</div>
<div class="paragraph">
<p><mark>下面的这些配置是 Consumer Pull 模式相关的配置。</mark>
<code>spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.consumer.pull.</code></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">pullThreadNums</dt>
<dd>
<p>消费时拉取的线程数</p>
<div class="paragraph">
<p>默认值: <code>20</code>.</p>
</div>
</dd>
<dt class="hdlist1">pollTimeoutMillis</dt>
<dd>
<p>拉取时的超时毫秒数</p>
<div class="paragraph">
<p>默认值: <code>1000 * 5</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>其他更多参数见 <code>com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQConsumerProperties.Pull</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
更多参数见 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/properties/RocketMQConsumerProperties.java">com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQConsumerProperties</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rocketmq_provider_properties">6.7.3. RocketMQ Provider Properties</h4>
<div class="paragraph">
<p>下面的这些配置是以 <code>spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.producer.</code> 为前缀的 RocketMQ Producer 相关的配置。更多见 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/properties/RocketMQProducerProperties.java">com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQProducerProperties</a></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">enable</dt>
<dd>
<p>是否启用 Producer。</p>
<div class="paragraph">
<p>默认值: <code>true</code>.</p>
</div>
</dd>
<dt class="hdlist1">group</dt>
<dd>
<p>Producer group name。</p>
<div class="paragraph">
<p>默认值: empty.</p>
</div>
</dd>
<dt class="hdlist1">maxMessageSize</dt>
<dd>
<p>消息发送的最大字节数。</p>
<div class="paragraph">
<p>默认值: <code>8249344</code>.</p>
</div>
</dd>
<dt class="hdlist1">producerType</dt>
<dd>
<p>消息生产者类型，普通或者事务。更多见 <code>com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQProducerProperties.ProducerType</code>.</p>
<div class="paragraph">
<p>默认值: <code>Normal</code>.</p>
</div>
</dd>
<dt class="hdlist1">transactionListener</dt>
<dd>
<p>事务消息监听器的beanName，在 <code>producerType=Trans</code> 时才有效；必须是实现 <code>org.apache.rocketmq.client.producer.TransactionListener</code> 接口的Spring Bean。</p>
</dd>
<dt class="hdlist1">sendType</dt>
<dd>
<p>消息发送类型（同步、异步、单向）。更多见`com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQProducerProperties.SendType`.</p>
<div class="paragraph">
<p>默认值: <code>Sync</code>.</p>
</div>
</dd>
<dt class="hdlist1">sendCallBack</dt>
<dd>
<p>消息发送后回调函数的beanName，在 <code>sendType=Async</code> 时才有效；必须是实现 <code>org.apache.rocketmq.client.producer.SendCallback</code> 接口的Spring Bean。</p>
</dd>
<dt class="hdlist1">vipChannelEnabled</dt>
<dd>
<p>是否在 Vip Channel 上发送消息。</p>
<div class="paragraph">
<p>默认值: <code>true</code>.</p>
</div>
</dd>
<dt class="hdlist1">sendMessageTimeout</dt>
<dd>
<p>发送消息的超时时间(毫秒)。</p>
<div class="paragraph">
<p>默认值: <code>3000</code>.</p>
</div>
</dd>
<dt class="hdlist1">compressMessageBodyThreshold</dt>
<dd>
<p>消息体压缩阀值(当消息体超过 4k 的时候会被压缩)。</p>
<div class="paragraph">
<p>默认值: <code>4096</code>.</p>
</div>
</dd>
<dt class="hdlist1">retryTimesWhenSendFailed</dt>
<dd>
<p>在同步发送消息的模式下，消息发送失败的重试次数。</p>
<div class="paragraph">
<p>默认值: <code>2</code>.</p>
</div>
</dd>
<dt class="hdlist1">retryTimesWhenSendAsyncFailed</dt>
<dd>
<p>在异步发送消息的模式下，消息发送失败的重试次数。</p>
<div class="paragraph">
<p>默认值: <code>2</code>.</p>
</div>
</dd>
<dt class="hdlist1">retryAnotherBroker</dt>
<dd>
<p>消息发送失败的情况下是否重试其它的 broker。</p>
<div class="paragraph">
<p>默认值: <code>false</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
生产者其他更多参数请见：
<a href="https://github.com/alibaba/spring-cloud-alibaba/blob/rocketmq/spring-cloud-alibaba-starters/spring-cloud-starter-stream-rocketmq/src/main/java/com/alibaba/cloud/stream/binder/rocketmq/properties/RocketMQProducerProperties.java">com.alibaba.cloud.stream.binder.rocketmq.properties.RocketMQProducerProperties</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_阿里云_mq_服务">6.8. 阿里云 MQ 服务</h3>
<div class="paragraph">
<p>使用阿里云 MQ 服务需要配置 AccessKey、SecretKey 以及云上的 NameServer 地址。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
0.1.2 &amp; 0.2.2 &amp; 0.9.0 才支持该功能
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.stream.rocketmq.binder.access-key=YourAccessKey
spring.cloud.stream.rocketmq.binder.secret-key=YourSecretKey
spring.cloud.stream.rocketmq.binder.name-server=NameServerInMQ</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
topic 和 group 请以 实例id% 为前缀进行配置。比如 topic 为 "test"，需要配置成 "实例id%test"
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="https://spring-cloud-alibaba.oss-cn-beijing.aliyuncs.com/MQ.png" alt="MQ">
</div>
<div class="title">Figure 6. NameServer 的获取(配置中请去掉 http:// 前缀)</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alicloud_ans">7. Spring Cloud AliCloud ANS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ANS（Application Naming Service） 是隶属于阿里云 EDAS 产品的组件， Spring Cloud AliCloud ANS 提供了 Spring Cloud 规范下商业版的服务注册与发现，可以让用户方便的在本地开发，同时也可以运行在云环境里。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
目前 EDAS 已经支持直接部署 Nacos Discovery 应用
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_如何引入_spring_cloud_alicloud_ans">7.1. 如何引入 Spring Cloud AliCloud ANS</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 ANS，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alicloud-ans</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alicloud-ans&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用ans进行服务注册">7.2. 使用ANS进行服务注册</h3>
<div class="paragraph">
<p>当客户端引入了 Spring Cloud AliCloud ANS Starter 以后，服务的元数据会被自动注册到注册中心，比如IP、端口、权重等信息。客户端会与服务端保持心跳，来证明自己可以正常提供服务。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的应用示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
@RestController
public class ProviderApplication {

    @RequestMapping("/")
    public String home() {
        return "Hello world";
    }

    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class, args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>既然服务会被注册到注册中心，那么肯定需要配置注册中心的地址，在 application.properties 中，还需要配置上以下地址。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties"># 应用名会被作为服务名称使用，因此会必选
spring.application.name=ans-provider
server.port=18081
# 以下就是注册中心的IP和端口配置
spring.cloud.alicloud.ans.server-list=127.0.0.1
spring.cloud.alicloud.ans.server-port=8080</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
此时没有启动注册中心，启动应用会报错，因此在应用启动之前，应当首先启动注册中心。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_启动注册中心">7.3. 启动注册中心</h3>
<div class="paragraph">
<p>ANS 使用的注册中心有两种，一种是完全免费的轻量版配置中心，主要用于开发和本地调试，一种是云上注册中心，ANS 依托于阿里云 EDAS 产品提供服务注册的功能。通常情况下，可以使用轻量版配置中心作为开发和测试环境，使用云上的 EDAS 作为灰度和生产环境。</p>
</div>
<div class="sect3">
<h4 id="_启动轻量版配置中心">7.3.1. 启动轻量版配置中心</h4>
<div class="paragraph">
<p>轻量版配置中心的下载和启动方式可参考 <a href="https://help.aliyun.com/document_detail/44163.html?spm=a2c4g.11186623.6.677.5f206b82Z2mTCF">这里</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
只需要进行第1步（下载轻量配置中心）和第2步（启动轻量配置中心）即可，第3步（配置hosts）在与 ANS 结合使用时，不需要操作。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>启动完轻量版配置中心以后，直接启动 ProviderApplication ，即可将服务注册到轻量版配置中心，由于轻量版配置中心的默认端口是8080，因此你可以打开 <a href="http://127.0.0.1:8080" class="bare">http://127.0.0.1:8080</a> ，点击左侧"服务列表"，查看注册上来的服务。</p>
</div>
</div>
<div class="sect3">
<h4 id="_使用云上注册中心">7.3.2. 使用云上注册中心</h4>
<div class="paragraph">
<p>使用云上注册中心，可以省去服务端的维护工作，同时稳定性也会更有保障。当使用云上注册中心时，代码部分和使用轻量配置中心并没有区别，但是配置上会有一些区别。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的使用云上配置中心的配置示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties"># 应用名会被作为服务名称使用，因此是必选
spring.application.name=ans-provider
# 端口配置自由配置即可
server.port=18081
# 以下就是注册中心的IP和端口配置，因为默认就是127.0.0.1和8080，因此以下两行配置也可以省略
spring.cloud.alicloud.ans.server-mode=EDAS
spring.cloud.alicloud.access-key=你的阿里云AK
spring.cloud.alicloud.secret-key=你的阿里云SK
spring.cloud.alicloud.edas.namespace=cn-xxxxx</code></pre>
</div>
</div>
<div class="paragraph">
<p>server-mode 的默认值为 LOCAL ，如果要使用云上注册中心，则需要更改为 EDAS 。</p>
</div>
<div class="paragraph">
<p>access-key 和 secret-key 则是阿里云账号的 AK/SK，需要首先注册阿里云账号，然后登陆 <a href="https://usercenter.console.aliyun.com/#/manage/ak">阿里云AK/SK管理页面</a> ，即可看到 AccessKey ID 和 Access Key Secret ，如果没有的话，需要点击"创建 AccessKey"按钮创建。</p>
</div>
<div class="paragraph">
<p>namespace 是阿里云 EDAS 产品的概念，用于隔离不同的环境，比如测试环境和生产环境。要获取 namespace 需要 <a href="https://common-buy.aliyun.com/?spm=5176.11451019.0.0.6f5965c0Uq5tue&amp;commodityCode=edaspostpay#/buy">开通 EDAS 服务</a>，按量计费模式下开通是免费的，开通以后进入 <a href="https://edas.console.aliyun.com/#/namespaces?regionNo=cn-hangzhou">EDAS控制台</a>，即可看到对应的 namespace，比如 cn-hangzhou。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
EDAS 提供应用托管服务，如果你将应用托管到 EDAS，那么 EDAS 将会自动为你填充所有配置。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alicloud_acm">8. Spring Cloud AliCloud ACM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud AliCloud ACM 是阿里云提供的商业版应用配置管理(Application Configuration Management) 产品 在 Spring Cloud 应用侧的客户端实现，且目前完全免费。</p>
</div>
<div class="paragraph">
<p>使用 Spring Cloud AliCloud ACM，可基于 Spring Cloud 的编程模型快速接入 ACM 配置管理功能。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
目前 EDAS 已经支持直接部署 Nacos Config 应用
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_如何引入_spring_cloud_alicloud_acm">8.1. 如何引入 Spring Cloud AliCloud ACM</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 ACM，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alicloud-acm</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alicloud-acm&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用_acm_进行配置管理">8.2. 使用 ACM 进行配置管理</h3>
<div class="paragraph">
<p>当客户端引入了 Spring Cloud AliCloud ACM Starter 以后，应用启动时会自动从配置管理的服务端获取配置信息，并注入到 Spring 的 Environment 中。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的应用示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class ProviderApplication {

    public static void main(String[] args) {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(ProviderApplication.class, args);
        String userName = applicationContext.getEnvironment().getProperty("user.name");
        String userAge = applicationContext.getEnvironment().getProperty("user.age");
        System.err.println("user name :"+userName+"; age: "+userAge);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在从配置中心服务端获取配置信息之前，还需要配置服务端的地址，在 bootstrap.properties 中，还需要配置以下信息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties"># 必选，应用名会被作为从服务端获取配置 key 的关键词组成部分
spring.application.name=acm-config
server.port=18081
# 以下就是配置中心服务端的IP和端口配置
spring.cloud.alicloud.acm.server-list=127.0.0.1
spring.cloud.alicloud.acm.server-port=8080</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
此时没有启动配置中心，启动应用会报错，因此在应用启动之前，应当首先启动配置中心。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_启动配置中心">8.2.1. 启动配置中心</h4>
<div class="paragraph">
<p>ACM 使用的配置中心有两种，一种是本地运行的轻量版配置中心，主要用于开发和本地调试，一种是阿里云产品 ACM。通常情况下，可以使用轻量版配置中心作为开发和测试环境，使用云上的 ACM 作为灰度和生产环境。</p>
</div>
<div class="sect4">
<h5 id="_使用轻量版配置中心">使用轻量版配置中心</h5>
<div class="paragraph">
<p>轻量版配置中心的下载和启动方式可参考 <a href="https://help.aliyun.com/document_detail/44163.html">这里</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
只需要执行文档中的第1步 (下载轻量配置中心) 和第2步 (启动轻量配置中心)。
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_使用阿里云配置中心">使用阿里云配置中心</h5>
<div class="paragraph">
<p>使用云上 ACM ，可以省去服务端的维护工作，同时稳定性也会更有保障。当使用云上配置中心时，代码部分和使用轻量配置中心并没有区别，但是配置上会有一些区别。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的使用云上配置中心的配置示例，配置详情需要在 <a href="https://acm.console.aliyun.com">ACM控制台查询</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties"># 应用名会被作为从服务端获取配置 key 的关键词组成部分，因此是必选
spring.application.name=acm-config
# 端口配置自由配置即可
server.port=18081
# 以下就是配置中心的IP和端口配置
spring.cloud.alicloud.acm.server-mode=EDAS
spring.cloud.alicloud.access-key=你的阿里云AK
spring.cloud.alicloud.secret-key=你的阿里云SK
spring.cloud.alicloud.acm.endpoint=acm.aliyun.com
spring.cloud.alicloud.acm.namespace=你的 ACM namespace，需要在 ACM 控制台查询</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
EDAS 提供应用托管服务，如果你将应用托管到 EDAS，那么 EDAS 将会自动为你填充所有与业务无关的配置。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_在配置中心添加配置">8.2.2. 在配置中心添加配置</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>启动好轻量版配置中心之后，在控制台中添加如下的配置。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Group:      DEFAULT_GROOUP

DataId:     acm-config.properties

Content:    user.name=james
            user.age=18</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
DataId 的格式为 <code>{prefix}.{file-extension}</code>,prefix 默认从配置 spring.application.name 中取值，file-extension 默认的值为 "properties"。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_启动应用验证">8.2.3. 启动应用验证</h4>
<div class="paragraph">
<p>启动这个Example，可以在控制台看到打印出的值正是我们在轻量版配置中心上预先配置的值。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>user name :james; age: 18</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_更改配置文件扩展名">8.3. 更改配置文件扩展名</h3>
<div class="paragraph">
<p>spring-cloud-starter-alicloud-acm 中 DataId 默认的文件扩展名是 properties。除去 properties 格式之外，也支持 yaml 格式。
支持通过 spring.cloud.alicloud.acm.file-extension 来配置文件的扩展名，yaml 格式可以配置成 <code>yaml</code> 或 <code>yml</code>。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
修改文件扩展名后，在配置中心中的 DataID 以及 Content 的格式都必须做相应的修改。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_动态更新">8.4. 动态更新</h3>
<div class="paragraph">
<p>spring-cloud-starter-alicloud-acm 默认支持配置的动态更新，当您在配置中心修改配置的内容时，会发布 Spring 中的 RefreshEvent 事件。
带有 @RefreshScope 和 @ConfigurationProperties 注解的类会自动刷新。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
你可以通过配置 spring.cloud.alicloud.acm.refresh.enabled=false 来关闭动态刷新。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_profile_粒度的配置">8.5. Profile 粒度的配置</h3>
<div class="paragraph">
<p>spring-cloud-starter-alicloud-acm 在加载配置的时候，首先会加载 DataId 为{spring.application.name}.{file-extension}的配置，当 spring.profiles.active 中配置有内容时，还会依次去加载 spring.profile 对应的内容， DataId 的格式为{spring.application.name}-{profile}.{file-extension}的配置，且后者的优先级高于前者。</p>
</div>
<div class="paragraph">
<p>spring.profiles.active 属于配置的元数据，所以也必须配置在 bootstrap.properties 或 bootstrap.yaml 中。比如可以在 bootstrap.properties 中增加如下内容。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.profiles.active={profile-name}</pre>
</div>
</div>
<div class="paragraph">
<p>Note: 也可以通过 JVM 参数 -Dspring.profiles.active=develop 或者 --spring.profiles.active=develop 这类优先级更高的方式来配置，只需遵循 Spring Boot 规范即可。</p>
</div>
</div>
<div class="sect2">
<h3 id="_自定义配置中心超时时间">8.6. 自定义配置中心超时时间</h3>
<div class="paragraph">
<p>ACM Client 与 Server 通信的超时时间默认是 3000ms，可以通过 <code>spring.cloud.alicloud.acm.timeout</code> 来修改超时时间，单位为 ms 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_自定义_group_的配置">8.7. 自定义 Group 的配置</h3>
<div class="paragraph">
<p>在没有明确指定 <code>{spring.cloud.alicloud.acm.group}</code> 配置的情况下， 默认使用的是 DEFAULT_GROUP 。如果需要自定义自己的 Group，可以通过以下配置来实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.acm.group=DEVELOP_GROUP</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
该配置必须放在 bootstrap.properties 文件中。并且在添加配置时 Group 的值要和 <code>spring.cloud.alicloud.acm.group</code> 的配置值一致。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_共享配置">8.8. 共享配置</h3>
<div class="paragraph">
<p>ACM 提供了一种多个应用之间共享配置中心的同一个配置的推荐方式，供多个应用共享一些配置时使用，您在使用的时候需要添加在 bootstrap 中添加一个配置项 <code>spring.application.group</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.application.group=company.department.team</code></pre>
</div>
</div>
<div class="paragraph">
<p>这时应用在获取上文提到的自身所独有的配置之前，会先依次从这些 DataId 去获取，分别是 company:application.properties, company.department:application.properties, company.department.team:application.properties。
然后，还会从 {spring.application.group}:{spring.application.name}.{file-extension} 中获取，越往后优先级越高，最高的仍然是应用自身所独有的配置。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
共享配置中 DataId 默认后缀为 properties，可以通过 spring.cloud.alicloud.acm.file-extension 配置. <code>{spring.application.group}:{spring.application.name}.{file-extension}</code> 。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
如果设置了 <code>spring.profiles.active</code> ，DataId 的格式还支持 <code>{spring.application.group}:{spring.application.name}-{spring.profiles.active}.{file-extension}</code>。优先级高于 <code>{spring.application.group}:{spring.application.name}.{file-extension}</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_actuator_监控">8.9. Actuator 监控</h3>
<div class="paragraph">
<p>ACM 对应的 Actuator 监控地址为 <code>/acm</code>，其中 <code>config</code> 代表了 ACM 元数据配置的信息，<code>runtime.sources</code> 对应的是从 ACM 服务端获取的配置的信息及最后刷新时间， <code>runtime.refreshHistory</code> 对应的是动态刷新的历史记录。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alicloud_oss">9. Spring Cloud AliCloud OSS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OSS（Object Storage Service）是阿里云的一款对象存储服务产品， Spring Cloud AliCloud OSS 提供了Spring Cloud规范下商业版的对象存储服务，提供简单易用的API，并且支持与 Spring 框架中 Resource 的整合。</p>
</div>
<div class="sect2">
<h3 id="_如何引入_spring_cloud_alicloud_oss">9.1. 如何引入 Spring Cloud AliCloud OSS</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 OSS，使用 group ID 为 <code>org.springframework.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alicloud-oss</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alicloud-oss&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用_oss_api">9.2. 如何使用 OSS API</h3>
<div class="sect3">
<h4 id="_配置_oss">9.2.1. 配置 OSS</h4>
<div class="paragraph">
<p>使用 Spring Cloud AliCloud OSS 之前，需要在 application.properties 中加入以下配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.access-key=你的阿里云AK
spring.cloud.alicloud.secret-key=你的阿里云SK
spring.cloud.alicloud.oss.endpoint=***.aliyuncs.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>access-key 和 secret-key 是阿里云账号的AK/SK，需要首先注册阿里云账号，然后登陆 <a href="https://usercenter.console.aliyun.com/#/manage/ak">阿里云AK/SK管理页面</a> ，即可看到 AccessKey ID 和 Access Key Secret ，如果没有的话，需要点击"创建AccessKey"按钮创建。</p>
</div>
<div class="paragraph">
<p>endpoint可以到 OSS 的 <a href="https://help.aliyun.com/document_detail/31837.html?spm=a2c4g.11186623.2.9.7dc72841Z2hGqa#concept-zt4-cvy-5db">官方文档</a>中查看，根据所在的 region ，填写对应的 endpoint 即可。</p>
</div>
</div>
<div class="sect3">
<h4 id="_引入_oss_api">9.2.2. 引入 OSS API</h4>
<div class="paragraph">
<p>Spring Cloud Alicloud OSS 中的 OSS API 基于阿里云官方OSS SDK提供，具备上传、下载、查看等所有对象存储类操作API。</p>
</div>
<div class="paragraph">
<p>一个简单的使用 OSS API 的应用如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class OssApplication {

    @Autowired
    private OSS ossClient;

    @RequestMapping("/")
    public String home() {
        ossClient.putObject("bucketName", "fileName", new FileInputStream("/your/local/file/path"));
        return "upload success";
    }

    public static void main(String[] args) throws URISyntaxException {
        SpringApplication.run(OssApplication.class, args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在上传文件之前，首先需要 <a href="https://account.aliyun.com/register/register.htm?spm=5176.8142029.388261.26.e9396d3eaYK2sG&amp;oauth_callback=https%3A%2F%2Fwww.aliyun.com%2F">注册阿里云账号</a> ，如果已经有的话，请 <a href="https://common-buy.aliyun.com/?spm=5176.8465980.unusable.dopen.4cdf1450rg8Ujb&amp;commodityCode=oss#/open">开通OSS服务</a>。</p>
</div>
<div class="paragraph">
<p>进入 <a href="https://oss.console.aliyun.com/overview">OSS控制台</a>，点击左侧"新建Bucket"，按照提示创建一个Bucket，然后将bucket名称替换掉上面代码中的"bucketName"，而"fileName"取任意文件名，"/your/local/file/path"取任意本地文件路径，然后 curl <a href="http://127.0.0.1:端口/" class="bare">http://127.0.0.1:端口/</a> 即可上传文件，可以到 <a href="https://oss.console.aliyun.com/overview">OSS控制台</a>查看效果。</p>
</div>
<div class="paragraph">
<p>更多关于 OSS API 的操作，可以参考 <a href="https://help.aliyun.com/document_detail/32008.html">OSS官方SDK文档</a>。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_与_spring_框架的_resource_结合">9.3. 与 Spring 框架的 Resource 结合</h3>
<div class="paragraph">
<p>Spring Cloud AliCloud OSS 整合了 Spring 框架的 Resource 规范，可以让用户很方便的引用 OSS 的资源。</p>
</div>
<div class="paragraph">
<p>一个简单的使用 Resource 的例子如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class OssApplication {

    @Value("oss://bucketName/fileName")
    private Resource file;

    @GetMapping("/file")
    public String fileResource() {
        try {
            return "get file resource success. content: " + StreamUtils.copyToString(
                file.getInputStream(), Charset.forName(CharEncoding.UTF_8));
        } catch (Exception e) {
            return "get resource fail: " + e.getMessage();
        }
    }

    public static void main(String[] args) throws URISyntaxException {
        SpringApplication.run(OssApplication.class, args);
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
以上示例运行的前提是，在 OSS 上需要有名为"bucketName"的Bucket，同时在该Bucket下，存在名为"fileName"的文件。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_采用_sts_授权">9.4. 采用 STS 授权</h3>
<div class="paragraph">
<p>Spring Cloud AliCloud OSS 除了 AccessKey/SecretKey 的授权方式以外，还支持 STS 授权方式。 STS 是临时访问令牌的方式，一般用于授权第三方，临时访问自己的资源。</p>
</div>
<div class="paragraph">
<p>作为第三方，也就是被授权者，只需要配置以下内容，就可以访问临时被授权的资源。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.oss.authorization-mode=STS
spring.cloud.alicloud.oss.endpoint=***.aliyuncs.com
spring.cloud.alicloud.oss.sts.access-key=你被授权的AK
spring.cloud.alicloud.oss.sts.secret-key=你被授权的SK
spring.cloud.alicloud.oss.sts.security-token=你被授权的ST</code></pre>
</div>
</div>
<div class="paragraph">
<p>其中 spring.cloud.alicloud.oss.authorization-mode 是枚举类型，此时填写 STS ，代表采用 STS 的方式授权。 endpoint可以到 OSS 的 <a href="https://help.aliyun.com/document_detail/31837.html?spm=a2c4g.11186623.2.9.7dc72841Z2hGqa#concept-zt4-cvy-5db">官方文档</a>中查看，根据所在的 region ，填写对应的 endpoint 即可。</p>
</div>
<div class="paragraph">
<p>access-key、secret-key和security-token需要由授权方颁发，如果对 STS 不了解的话，可以参考 <a href="https://help.aliyun.com/document_detail/31867.html">STS官方文档</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_更多客户端配置">9.5. 更多客户端配置</h3>
<div class="paragraph">
<p>除了基本的配置项以外， Spring Cloud AliCloud OSS 还支持很多额外的配置，也是在 application.properties 文件中。</p>
</div>
<div class="paragraph">
<p>以下是一些简单的示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.oss.authorization-mode=STS
spring.cloud.alicloud.oss.endpoint=***.aliyuncs.com
spring.cloud.alicloud.oss.sts.access-key=你被授权的AK
spring.cloud.alicloud.oss.sts.secret-key=你被授权的SK
spring.cloud.alicloud.oss.sts.security-token=你被授权的ST

spring.cloud.alicloud.oss.config.connection-timeout=3000
spring.cloud.alicloud.oss.config.max-connections=1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果想了解更多的配置项，可以参考 <a href="https://help.aliyun.com/document_detail/32010.html?spm=a2c4g.11186623.6.703.50b25413nGsYHc">OSSClient配置项</a> 的末尾表格。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
通常情况下，都需要将 <a href="https://help.aliyun.com/document_detail/32010.html?spm=a2c4g.11186623.6.703.50b25413nGsYHc">OSSClient配置项</a> 末尾表格中的参数名更换成"-"连接，且所有字母小写。例如 ConnectionTimeout，对应 connection-timeout。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alicloud_schedulerx">10. Spring Cloud AliCloud SchedulerX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SchedulerX（分布式任务调度） 是隶属于阿里云EDAS产品的组件， Spring Cloud AliCloud SchedulerX 提供了在Spring Cloud的配置规范下，分布式任务调度的功能支持。SchedulerX可提供秒级、精准、高可靠、高可用的定时任务调度服务，并支持多种类型的任务调度，如简单单机任务、简单多机任务、脚本任务以及网格任务。</p>
</div>
<div class="sect2">
<h3 id="_如何引入_spring_cloud_alicloud_schedulerx">10.1. 如何引入 Spring Cloud AliCloud SchedulerX</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 SchedulerX，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alicloud-schedulerX</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alicloud-schedulerX&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_启动schedulerx任务调度">10.2. 启动SchedulerX任务调度</h3>
<div class="paragraph">
<p>当客户端引入了 Spring Cloud AliCloud SchedulerX Starter 以后，只需要进行一些简单的配置，就可以自动初始化SchedulerX的任务调度服务。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的应用示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class ScxApplication {

    public static void main(String[] args) {
        SpringApplication.run(ScxApplication.class, args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在application.properties中，需要加上以下配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">server.port=18033
# 其中cn-test是SchedulerX的测试区域
spring.cloud.alicloud.scx.group-id=***
spring.cloud.alicloud.edas.namespace=cn-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>在获取group-id之前，需要首先 <a href="https://account.aliyun.com/register/register.htm?spm=5176.8142029.388261.26.e9396d3eEIv28g&amp;oauth_callback=https%3A%2F%2Fwww.aliyun.com%2F">注册阿里云账号</a> ，然后 <a href="https://common-buy.aliyun.com/?spm=5176.11451019.0.0.6f5965c0Uq5tue&amp;commodityCode=edaspostpay#/buy">开通EDAS服务</a> ，并 <a href="https://edas.console.aliyun.com/#/edasTools">开通分布式任务管理组件</a> 。</p>
</div>
<div class="paragraph">
<p>其中group-id的获取，请参考 <a href="https://help.aliyun.com/document_detail/98784.html?spm=a2c4g.11186623.2.17.23c87da9P2F3tG">这里</a>。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
在创建group的时候，要选择"测试"区域。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_编写一个简单任务">10.3. 编写一个简单任务</h3>
<div class="paragraph">
<p>简单任务是最常用的任务类型，只需要实现 ScxSimpleJobProcessor 接口即可。</p>
</div>
<div class="paragraph">
<p>以下是一个简单的单机类型任务示例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class SimpleTask implements ScxSimpleJobProcessor {

	@Override
	public ProcessResult process(ScxSimpleJobContext context) {
		System.out.println("-----------Hello world---------------");
		ProcessResult processResult = new ProcessResult(true);
		return processResult;
	}

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_对任务进行调度">10.4. 对任务进行调度</h3>
<div class="paragraph">
<p>进入 <a href="https://edas.console.aliyun.com/#/edasSchedulerXJob?regionNo=cn-test">SchedulerX任务列表</a> 页面，选择上方"测试"区域，点击右上角"新建Job"，创建一个Job，即如下所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="text">Job分组：测试——***-*-*-****
Job处理接口：org.springframework.cloud.alibaba.cloud.examples.SimpleTask
类型：简单Job单机版
定时表达式：默认选项——0 * * * * ?
Job描述：无
自定义参数：无</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上任务类型选择了"简单Job单机版"，并且制定了Cron表达式为"0 * * * * ?"，这意味着，每过一分钟，任务将会被执行且只执行一次。</p>
</div>
<div class="paragraph">
<p>更多任务类型，请参考 <a href="https://help.aliyun.com/document_detail/43136.html">SchedulerX官方文档</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_生产环境使用">10.5. 生产环境使用</h3>
<div class="paragraph">
<p>以上使用的都是SchedulerX的"测试"区域，主要用于本地调试和测试。</p>
</div>
<div class="paragraph">
<p>在生产级别，除了上面的group-id和namespace以外，还需要一些额外的配置，如下所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">server.port=18033
# 其中cn-test是SchedulerX的测试区域
spring.cloud.alicloud.scx.group-id=***
spring.cloud.alicloud.edas.namespace=***
# 当应用运行在EDAS上时，以下配置不需要手动配置。
spring.cloud.alicloud.access-key=***
spring.cloud.alicloud.secret-key=***
# 以下配置不是必须的，请参考SchedulerX文档
spring.cloud.alicloud.scx.domain-name=***</code></pre>
</div>
</div>
<div class="paragraph">
<p>其中group-id与之前的获取方式一样，namespace则是从EDAS控制台左侧"命名空间"列表中获取命名空间ID。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
group-id必须创建在namespace当中。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>access-key以及secret-key为阿里云账号的AK/SK信息，如果应用在EDAS上部署，则不需要填写这两项信息，否则请前往 <a href="https://usercenter.console.aliyun.com/#/manage/ak">安全信息管理</a>获取。</p>
</div>
<div class="paragraph">
<p>domain-name并不是必须的，具体请参考 <a href="https://help.aliyun.com/document_detail/35359.html">SchedulerX官方文档</a>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alicloud_sms">11. Spring Cloud AliCloud SMS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>短信服务（Short Message Service）是阿里云为用户提供的一种通信服务的能力。 Spring Cloud AliCloud SMS 实现了与 SMS 的简单集成，提供更为简单易用的 API，可以基于 Spring Cloud Alibaba SMS 来快速的接入阿里云的 SMS 服务。</p>
</div>
<div class="sect2">
<h3 id="_如何引入_spring_cloud_alicloud_sms">11.1. 如何引入 Spring Cloud AliCloud SMS</h3>
<div class="paragraph">
<p>如果要在您的项目中引入 SMS，使用 group ID 为 <code>com.alibaba.cloud</code> 和 artifact ID 为 <code>spring-cloud-starter-alicloud-sms</code> 的 starter。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alicloud-sms&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用_sms_api">11.2. 如何使用 SMS API</h3>
<div class="sect3">
<h4 id="_配置_sms">11.2.1. 配置 SMS</h4>
<div class="paragraph">
<p>使用 Spring Cloud AliCloud SMS 之前，需要在 application.properties 中加入以下配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.access-key=你的阿里云 AK
spring.cloud.alicloud.secret-key=你的阿里云 SK</code></pre>
</div>
</div>
<div class="paragraph">
<p>access-key 和 secret-key 是阿里云账号的 AK/SK，需要首先注册阿里云账号，然后登陆 <a href="https://usercenter.console.aliyun.com/#/manage/ak">阿里云AK/SK管理页面</a> ，即可看到 AccessKey ID 和 Access Key Secret ，如果没有的话，需要点击"创建AccessKey"按钮创建。</p>
</div>
</div>
<div class="sect3">
<h4 id="_引入_sms_api">11.2.2. 引入 SMS API</h4>
<div class="paragraph">
<p>Spring Cloud Alicloud SMS 中的 SMS API 基于阿里云官方 SMS SDK ,提供具备单个短信发送、多个短信批量发送、短信查询、短信消息(<code>短信回执消息</code> 和 <code>上行短信消息</code>) 类型操作API。</p>
</div>
<div class="paragraph">
<p>一个简单的使用 SMS API 发送短信的应用如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SpringBootApplication
public class SmsApplication {

    @Autowired
    private ISmsService smsService;

    /**
     * 短信发送 Example
     * @param code
     * @return
     */
    @RequestMapping("/batch-sms-send.do")

    public SendBatchSmsResponse batchsendCheckCode(
            @RequestParam(name = "code") String code) {

        // 组装请求对象-具体描述见控制台-文档部分内容
        SendSmsRequest request = new SendSmsRequest();
        // 必填:待发送手机号
        request.setPhoneNumbers("152******");
        // 必填:短信签名-可在短信控制台中找到
        request.setSignName("******");
        // 必填:短信模板-可在短信控制台中找到
        request.setTemplateCode("******");
        // 可选:模板中的变量替换JSON串,如模板内容为"【企业级分布式应用服务】,您的验证码为${code}"时,此处的值为
        request.setTemplateParam("{\"code\":\"" + code + "\"}");
        SendSmsResponse sendSmsResponse ;
        try {
            sendSmsResponse = smsService.sendSmsRequest(request);
        }
        catch (ClientException e) {
            e.printStackTrace();
            sendSmsResponse = new SendSmsResponse();
        }
        return sendSmsResponse ;
    }

    public static void main(String[] args) throws URISyntaxException {

        SpringApplication.run(SmsApplication.class, args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在发送短信之前，首先需要 <a href="https://account.aliyun.com/register/register.htm?spm=5176.8142029.388261.26.e9396d3eaYK2sG&amp;oauth_callback=https%3A%2F%2Fwww.aliyun.com%2F">注册阿里云账号</a> ，如果已经有的话，请 <a href="https://dysms.console.aliyun.com/dysms.htm?spm=5176.8195934.1283918..18924183bHPct2&amp;accounttraceid=c8cb4243-3080-4eb1-96b0-1f2316584269#/">开通 SMS 服务</a>。</p>
</div>
<div class="paragraph">
<p>更多关于 SMS 发送短信的步骤，可以参考 SMS 官方 <a href="https://help.aliyun.com/document_detail/55284.html?spm=a2c4g.11186623.6.568.715e4f30ZiVkbI">短信发送API(SendSms)---JAVA</a> 文档。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
由于早期的 SMS sdk 版本的问题，如果短信发送失败，请将代码中含有明确指定 MethodType 为 POST 的这行代码给删除掉。如果还有问题，请第一时间联系我们。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sms_api_的高级功能">11.3. SMS Api 的高级功能</h3>
<div class="paragraph">
<p>Spring Cloud Alicloud SMS 封装的 API 接口为了降低学习的成本，尽量保持和官网提供的 API 以及 Example 保持一致。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>批量短信发送</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>参考以下的 Example ，来快速开发一个具有批量短信发送的功能。在 Controller 中或者新建一个 Controler 新增如下代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/**
 * 批量短信发送 Example
 * @param code
 * @return
 */
@RequestMapping("/batch-sms-send.do")
public SendBatchSmsResponse batchsendCheckCode(
        @RequestParam(name = "code") String code) {
    // 组装请求对象
    SendBatchSmsRequest request = new SendBatchSmsRequest();
    // 使用 GET 提交
    request.setMethod(MethodType.GET);
    // 必填:待发送手机号。支持JSON格式的批量调用，批量上限为100个手机号码,批量调用相对于单条调用及时性稍有延迟,验证码类型的短信推荐使用单条调用的方式
    request.setPhoneNumberJson("[\"177********\",\"130********\"]");
    // 必填:短信签名-支持不同的号码发送不同的短信签名
    request.setSignNameJson("[\"*******\",\"*******\"]");
    // 必填:短信模板-可在短信控制台中找到
    request.setTemplateCode("******");
    // 必填:模板中的变量替换JSON串,如模板内容为"亲爱的${name},您的验证码为${code}"时,此处的值为
    // 友情提示:如果JSON中需要带换行符,请参照标准的JSON协议对换行符的要求,比如短信内容中包含\r\n的情况在JSON中需要表示成\\r\\n,否则会导致JSON在服务端解析失败
    request.setTemplateParamJson(
            "[{\"code\":\"" + code + "\"},{\"code\":\"" + code + "\"}]");
    SendBatchSmsResponse sendSmsResponse ;
    try {
        sendSmsResponse = smsService
                .sendSmsBatchRequest(request);
        return sendSmsResponse;
    }
    catch (ClientException e) {
        e.printStackTrace();
        sendSmsResponse =  new SendBatchSmsResponse();
    }
    return sendSmsResponse ;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
这里设置请求的 MethodType 为 GET，和官网给出的例子还有些不一样。这是因为依赖的阿里云 POP API 版本不一致导致不兼容的问题，设置为 GET 即可。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>更多的参数说明可 <a href="https://help.aliyun.com/document_detail/66041.html?spm=a2c4g.11186623.6.571.631315e8AauJhP">参考这里</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>短信查询</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>参考以下的 Example ，可以快速开发根据某个指定的号码查询短信历史发送状态。在 Controller 中或者新建一个 Controler 新增如下代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/**
 *
 * 短信查询 Example
 * @param telephone
 * @return
 */
@RequestMapping("/query.do")
public QuerySendDetailsResponse querySendDetailsResponse(
        @RequestParam(name = "tel") String telephone) {
    // 组装请求对象
    QuerySendDetailsRequest request = new QuerySendDetailsRequest();
    // 必填-号码
    request.setPhoneNumber(telephone);
    // 必填-短信发送的日期 支持30天内记录查询（可查其中一天的发送数据），格式yyyyMMdd
    request.setSendDate("20190103");
    // 必填-页大小
    request.setPageSize(10L);
    // 必填-当前页码从1开始计数
    request.setCurrentPage(1L);
    try {
        QuerySendDetailsResponse response = smsService.querySendDetails(request);
        return response;
    }
    catch (ClientException e) {
        e.printStackTrace();
    }

    return new QuerySendDetailsResponse();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>更多的参数说明，可 <a href="https://help.aliyun.com/document_detail/55289.html?spm=a2c4g.11186623.6.569.4f852c78mugEfx">参考这里</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>短信回执消息</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>通过订阅 SmsReport 短信状态报告，可以获知每条短信的发送情况，了解短信是否达到终端用户的状态与相关信息。这些工作已经都被 Spring Cloud AliCloud SMS 封装在内部了。你只需要完成以下两步即可。</p>
</div>
<div class="paragraph">
<p>1、在 <code>application.properties</code> 配置文件中(也可以是 application.yaml)配置 SmsReport 的队列名称。</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="properties">spring.cloud.alicloud.sms.report-queue-name=Alicom-Queue-********-SmsReport</code></pre>
</div>
</div>
<div class="paragraph">
<p>2、 实现 SmsReportMessageListener 接口，并初始化一个 Spring Bean 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/**
 * 如果需要监听短信是否被对方成功接收，只需实现这个接口并初始化一个 Spring Bean 即可。
 */
@Component
public class SmsReportMessageListener
		implements org.springframework.cloud.alicloud.sms.SmsReportMessageListener {

	@Override
	public boolean dealMessage(Message message) {
	    // 在这里添加你的处理逻辑

	    //do something

		System.err.println(this.getClass().getName() + "; " + message.toString());
		return true;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>更多关于 Message 的消息体格式可  <a href="https://help.aliyun.com/document_detail/55496.html?spm=a2c4g.11186623.6.570.7f792c78rOiWXO">参考这里</a>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>上行短信消息</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>通过订阅SmsUp上行短信消息，可以获知终端用户回复短信的内容。这些工作也已经被 Spring Cloud AliCloud SMS 封装好了。你只需要完成以下两步即可。</p>
</div>
<div class="paragraph">
<p>1、 在 <code>application.properties</code> 配置文件中(也可以是 application.yaml)配置 SmsReport 的队列名称。</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre>spring.cloud.alicloud.sms.up-queue-name=Alicom-Queue-********-SmsUp</pre>
</div>
</div>
<div class="paragraph">
<p>2、实现 SmsUpMessageListener 接口，并初始化一个 Spring Bean 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/**
 * 如果发送的短信需要接收对方回复的状态消息，只需实现该接口并初始化一个 Spring Bean 即可。
 */
@Component
public class SmsUpMessageListener
		implements org.springframework.cloud.alicloud.sms.SmsUpMessageListener {

	@Override
	public boolean dealMessage(Message message) {
	    // 在这里添加你的处理逻辑

    	//do something

		System.err.println(this.getClass().getName() + "; " + message.toString());
		return true;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>更多关于 Message 的消息体格式可  <a href="https://help.aliyun.com/document_detail/55496.html?spm=a2c4g.11186623.6.570.7f792c78rOiWXO">参考这里</a>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_sidecar">12. Spring Cloud Alibaba Sidecar</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Spring Cloud Alibaba Sidecar</code> 是一个用来快速<strong>完美整合</strong> Spring Cloud
与 <strong>异构微服务</strong> 的框架，灵感来自
<a href="https://github.com/spring-cloud/spring-cloud-netflix/tree/master/spring-cloud-netflix-sidecar">Spring
Cloud Netflix Sidecar</a>，目前支持的服务发现组件：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nacos</p>
</li>
<li>
<p>Consul</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_术语">12.1. 术语</h3>
<div class="sect3">
<h4 id="_异构微服务">12.1.1. 异构微服务</h4>
<div class="paragraph">
<p>非Spring Cloud应用，统称异构微服务。比如你的遗留项目，或者非JVM应用。</p>
</div>
</div>
<div class="sect3">
<h4 id="_完美整合的三层含义">12.1.2. "完美整合"的三层含义</h4>
<div class="ulist">
<ul>
<li>
<p>享受服务发现的优势</p>
</li>
<li>
<p>有负载均衡</p>
</li>
<li>
<p>有断路器</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_or_why_not">12.2. Why or Why not?</h3>
<div class="sect3">
<h4 id="_为什么要编写alibaba_sidecar">12.2.1. 为什么要编写Alibaba Sidecar？</h4>
<div class="paragraph">
<p>原因有两点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud子项目 <code>Spring Cloud Netflix Sidecar</code>
是可以快速整合异构微服务的。然而，Sidecar只支持使用Eureka作为服务发现，<strong>如果使用其他服务发现组件就抓瞎了</strong>。</p>
</li>
<li>
<p><strong>Sidecar是基于Zuul 1.x的</strong>，Spring
Cloud官方明确声明，未来将会逐步淘汰Zuul。今年早些时候，我有给Spring
Cloud官方提出需求，希望官方实现一个基于Spring Cloud
Gateway的新一代Sidecar，然而官方表示并没有该计划。详见：https://github.com/spring-cloud/spring-cloud-gateway/issues/735</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>既然没有，索性自己写了。</p>
</div>
</div>
<div class="sect3">
<h4 id="_为什么不用service_mesh">12.2.2. 为什么不用Service Mesh？</h4>
<div class="ulist">
<ul>
<li>
<p>目前Mesh主要使用场景在Kubernetes领域（Istio、Linkerd
2等，大多将Kubernetes作为First
Class支持，虽然Istio也可部署在非Kubernetes环境），而目前业界，Spring
Cloud应用未必有试试Mesh的环境；</p>
</li>
<li>
<p>使用Alibaba
Sidecar一个小组件就能解决问题了（核心代码不超过200行），引入整套Mesh方案，颇有点屠龙刀杀黄鳝的意思。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_原理">12.3. 原理</h3>
<div class="ulist">
<ul>
<li>
<p>Alibaba
Sidecar根据配置的异构微服务的IP、端口等信息，<strong>将异构微服务的IP/端口注册到服务发现组件上</strong>
。</p>
</li>
<li>
<p>Alibaba Sidecar实现了 <strong>健康检查</strong> ，Alibaba
Sidecar会定时检测异构微服务是否健康。如果发现异构微服务不健康，Alibaba
Sidecar会自动将代表异构微服务的Alibaba
Sidecar实例下线；如果异构微服务恢复正常，则会自动上线。最长延迟是30秒，详见
<code>Alibaba SidecarChecker#check</code> 。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_要求">12.4. 要求</h3>
<div class="ulist">
<ul>
<li>
<p>【必须】你的异构微服务需使用HTTP通信。这一点严格来说不算要求，因为Spring
Cloud本身就是基于HTTP的；</p>
</li>
<li>
<p>【可选】如果微服务配置了 <code>sidecar.health-check-url</code>
，则表示开启健康检查，此时，你的异构微服务需实现健康检查（可以是空实现，只要暴露一个端点，返回类似
<code>{"status": "UP"}</code> 的字符串即可）。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_使用示例">12.5. 使用示例</h3>
<div class="ulist">
<ul>
<li>
<p>如使用Nacos作为服务发现组件，详见`spring-cloud-alibaba-examples/spring-cloud-alibaba-sidecar-examples/spring-cloud-alibaba-sidecar-nacos-example`</p>
</li>
<li>
<p>如使用Consul作为服务发现组件，详见`spring-cloud-alibaba-examples/spring-cloud-alibaba-sidecar-examples/spring-cloud-alibaba-sidecar-nacos-example`</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_示例代码以nacos服务发现为例">12.5.1. 示例代码（以Nacos服务发现为例）</h4>
<div class="ulist">
<ul>
<li>
<p>加依赖：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-alibaba-sidecar&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>写配置：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">server:
  port: 8070
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    gateway:
      discovery:
        locator:
          enabled: true
  application:
    name: node-service
sidecar:
  # 异构微服务的IP
  ip: 127.0.0.1
  # 异构微服务的端口
  port: 8060
  # 异构微服务的健康检查URL
  health-check-url: http://localhost:8060/health.json
management:
endpoint:
    health:
      show-details: always</code></pre>
</div>
</div>
<div class="paragraph">
<p>配置比较简单，就是把Alibaba Sidecar注册到Nacos上，然后添加了几行Alibaba
Sidecar的配置。</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_异构微服务_2">12.5.2. 异构微服务</h4>
<div class="paragraph">
<p>我准备了一个NodeJS编写的简单微服务。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">var http = require('http');
var url = require("url");
var path = require('path');

// 创建server
var server = http.createServer(function(req, res) {
    // 获得请求的路径
    var pathname = url.parse(req.url).pathname;
    res.writeHead(200, { 'Content-Type' : 'application/json; charset=utf-8' });
    // 访问http://localhost:8060/，将会返回{"index":"欢迎来到首页"}
    if (pathname === '/') {
        res.end(JSON.stringify({ "index" : "欢迎来到首页" }));
    }
    // 访问http://localhost:8060/health，将会返回{"status":"UP"}
    else if (pathname === '/health.json') {
        res.end(JSON.stringify({ "status" : "UP" }));
    }
    // 其他情况返回404
    else {
        res.end("404");
    }
});
// 创建监听，并打印日志
server.listen(8060, function() {
    console.log('listening on localhost:8060');
});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_测试">12.5.3. 测试</h4>
<div class="sect4">
<h5 id="_测试1spring_cloud微服务完美调用异构微服务">测试1：Spring Cloud微服务完美调用异构微服务</h5>
<div class="paragraph">
<p>为你的Spring Cloud微服务整合Ribbon，然后构建 <code><a href="http://node-service/" class="bare">http://node-service/</a><strong></code>
，就可以请求到异构微服务的 <code>/</strong></code> 了。</p>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="paragraph">
<p>Ribbon请求 <code><a href="http://node-service/" class="bare">http://node-service/</a></code> 会请求到 <code><a href="http://localhost:8060/" class="bare">http://localhost:8060/</a></code>
，以此类推。</p>
</div>
<div class="paragraph">
<p>至于断路器，正常为你的Spring
Cloud微服务整合Sentinel或者Hystirx、Resilience4J即可 。</p>
</div>
</div>
<div class="sect4">
<h5 id="_测试2异构微服务完美调用spring_cloud微服务">测试2：异构微服务完美调用Spring Cloud微服务</h5>
<div class="paragraph">
<p>由于Alibaba Sidecar基于Spring Cloud Gateway，而网关自带转发能力。</p>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="paragraph">
<p>如果你有一个Spring Cloud微服务叫做 <code>spring-cloud-microservice</code>
，那么NodeJS应用只需构建
<code><a href="http://localhost:8070/spring-cloud-microservice/" class="bare">http://localhost:8070/spring-cloud-microservice/</a><strong></code> ，Alibaba
Sidecar就会把请求转发到 <code>spring-cloud-microservice</code> 的 <code>/</strong></code> 。</p>
</div>
<div class="paragraph">
<p>而Spring Cloud Gateway是整合了Ribbon的，所以实现了负载均衡；Spring Cloud
Gateway还可以整合Sentinel或者Hystirx、Resilience4J，所以也带有了断路器。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_alibaba_sidecar优缺点分析">12.6. Alibaba Sidecar优缺点分析</h3>
<div class="paragraph">
<p>Alibaba
Sidecar的设计和Sidecar基本一致，优缺点和Sidecar的优缺点也是一样的。</p>
</div>
<div class="paragraph">
<p>优点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>接入简单，几行代码就可以将异构微服务整合到Spring Cloud生态</p>
</li>
<li>
<p>不侵入原代码</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>缺点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>每接入一个异构微服务实例，都需要额外部署一个Alibaba
Sidecar实例，增加了部署成本（虽然这个成本在Kubernetes环境中几乎可以忽略不计（只需将Alibaba
Sidecar实例和异构微服务作为一个Pod部署即可））；</p>
</li>
<li>
<p>异构微服务调用Spring Cloud微服务时，本质是把Alibaba
Sidecar当网关在使用，经过了一层转发，性能有一定下降。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_appactive">13. Spring Cloud Alibaba AppActive</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_appactive介绍">13.1. AppActive介绍</h3>
<div class="paragraph">
<p>AppActive，是一个面向业务应用构建云原生高可用多活容灾架构的开源中间件。它提供了应用多活容灾架构的标准、实现和 Demo，适用于丰富的业务场景（单 AZ、单 Region、单云、多 AZ、多 Region、多云、自建 IDC等）。</p>
</div>
<div class="paragraph">
<p>AppActive 建立在 阿里巴巴 使用 AHAS-MSHA 系统大规模运行生产应用系统的8年经验之上，且结合了来自阿里云商业化服务的外部多家客户和社区的最佳实践，具备高可靠、可拓展等特性。</p>
</div>
<div class="paragraph">
<p>AppActive 具备以下特性</p>
</div>
<div class="sect3">
<h4 id="_单元分流">13.1.1. 单元分流</h4>
<div class="sect4">
<h5 id="_流量统一接入">流量统一接入</h5>
<div class="paragraph">
<p>对流量的把控能力，来源于流量的统一接入，我们将这一层称为接入层。接入层是单元所有流量的入口，它能解析请求协议，并按照设置的分流模式与分流粒度，将请求流量正确引导到正确单元的相应应用服务SLB上。下文若无特殊说明，请求协议默认HTTP。下图为接入层示意图。</p>
</div>
</div>
<div class="sect4">
<h5 id="_分流模式">分流模式</h5>
<div class="paragraph">
<p>多活场景下，流量会按照某个纬度切片，分流到不同的单元。多活支持多种分流模式，比如按比例分流，按业务属性分流，具体选择哪种分流模式还是取决于业务场景需要。分流模式最终体现在路由规则里，路由规则是一项配置，它定义了某个流量应该隶属于哪个单元。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>按比例分流。在某些业务场景下，需要按用户分流，或者按设备号分流。用户、设备等都可以抽象成一个ID，那就可以将ID划为多个区间，每个区间归属于某个单元。这种分流模式，每个单元的流量比例，就可以通过ID区间进行估算，通过设置ID区间与单元容量的比例一致，就可以做到全局的负载均衡。</p>
</li>
<li>
<p>按业务属性分流。在某些业务场景下，需要按流量属性分流，比如将爬虫流量引入特定单元，或者按省份分流。爬虫、省份等都可以抽象成一个标签，那就可以将不同的标签值流量引入不同单元。这种分流模式，可以支持对不同业务属性的流量进行物理隔离。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_分流粒度">分流粒度</h5>
<div class="paragraph">
<p>随着应用服务化，当今应用早已不是单体架构，提供用户访问入口的应用也可能成百上千。接入层将用户流量引入正确的应用，支持域名与URI前缀两种粒度。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>按域名分流。按照不同域名区分不同应用。比如应用app1的域名是app1.example.com，app2的域名是app2.example.com。</p>
</li>
<li>
<p>按URI前缀分流。按照不同URI前缀区分不同应用。比如应用app1与app2的域名都是app.example.com，但是将URI中/app1前缀的流量引入app1，将/app2前缀的流量引入app2。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_流量协议">流量协议</h5>
<div class="paragraph">
<p>接入层支持四层、七层丰富的流量请求协议，以满足用户互联网、物联网等多样化场景需求。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>HTTP协议支持。接入层默认支持HTTP协议，从HTTP协议中解析出域名与URI，进行转发路由。</p>
</li>
<li>
<p>HTTPS协议支持。接入层支持HTTPS协议，提供集中化的域名证书管理，满足用户可靠传输、安全传输的要求。用户在接入层配置好域名证书，则应用SLB无需再配置证书。</p>
</li>
<li>
<p>其他协议支持。接入层除了支持HTTP与HTTPS协议，还支持其他基于HTTP的协议，比如SOAP等。接入层在协议上有很大的扩展性，能以插件的形式迅速支持特殊协议，比如物联网场景下的MQTT，COAP等。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_路由透传">路由透传</h5>
<div class="paragraph">
<p>为了确保流量能在单元内闭环，接入层、应用层、数据层每一层都会进行路由纠错或单元保护。为了识别流量，需要明确流量所属的单元化类型与分流id，我们称之为路由参数，以便通过路由规则计算出流量所属正确单元，因此，路由参数需要跟随请求路径一路传递，我们称之为路由透传。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>接入层路由透传。当浏览器发起业务请求时，需要在请求中携带路由参数。路由参数可以在cookie、head或body中，建议cookie。接入层能解析HTTP请求，拿到路由参数并路由到正确的应用SLB，同时应用服务器仍然能从请求中拿到原生的路由参数。</p>
</li>
<li>
<p>应用层路由透传。流量到达应用服务器，多活提供插件从HTTP请求中提取路由参数，并保存到上下文，下一步应用可能会发起RPC调用或异步消息，因此路由参数还需要在RPC与消息层面透传。</p>
</li>
<li>
<p>RPC路由透传。当应用发起RPC调用时，RPC客户端能从上下文中取出路由参数，并跟随RPC请求到远程服务提供者Provider，Provider客户端识别出Request中的路由参数，亦保存到调用上下文。路由参数在RPC中的传递过程对用户透明。</p>
</li>
<li>
<p>消息路由透传。MQ客户端在发送消息时，会从当前上下文获取路由参数添加到消息属性中。MQ客户端消费消息时，能从消息属性中取出路由参数，亦保存到调用上下文。路由参数在MQ中的传递过程对用户透明。</p>
</li>
<li>
<p>数据层路由透传。数据脏写会造成很严重的后果，因此要保证数据落库到正确单元的DB。多活提供了 DRIVER 插件，对非本单元的请求拒绝。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_单元协同">13.1.2. 单元协同</h4>
<div class="paragraph">
<p>在容灾场景中，理想场景中各个单元独立，但实际上会存在部分跨单元场景的业务场景，为了满足这些场景，产品需要提供单元协同的能力。</p>
</div>
<div class="sect4">
<h5 id="_中心调用">中心调用</h5>
<div class="paragraph">
<p>有些特定业务场景，为保证数据强一致性，特定服务只能在特定中心单元提供，所有对中心服务的调用都会直接路由到中心单元来完成。异地多活产品通过CSB组件和RPC多活插件来完成服务单元间协同调用，满足业务的完整性。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_单元保护">13.1.3. 单元保护</h4>
<div class="paragraph">
<p>产品保证业务逻辑的全局正确性，不会因切流操作导致单元业务逻辑不一致问题。系统自上而下各层都有对错误流量的纠错保护能力，保证业务按单元化规则进行正确的流转。</p>
</div>
<div class="sect4">
<h5 id="_接入层纠错">接入层纠错</h5>
<div class="paragraph">
<p>流量打入接入层，接入层通过请求附加的路由参数判断流量归属单元，非本单元流量将被代理到正确的目标单元，保证了接入层入口流量的正确性。</p>
</div>
</div>
<div class="sect4">
<h5 id="_rpc纠错">RPC纠错</h5>
<div class="paragraph">
<p>RPC服务调用时，RPC多活Plugin在Consumer端会根据请求的单元信息，对服务调用进行正确的路由选址，对错误的流量服务调用，RPC多活Plugin会计算出正确的目标单元，跨单元调用目标单元服务，保证服务流转逻辑的一致性。同时RPC多活Plugin 在Provider端会对过来的请求进行二次校验，保证服务调用的正确。通过双重校验机制，RPC多活Plugin实现对RPC调用的纠错，保证服务调用的正确性。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_单元扩展">13.1.4. 单元扩展</h4>
<div class="sect4">
<h5 id="_水平扩展">水平扩展</h5>
<div class="paragraph">
<p>当现有单元的业务承载量已达上限且无法扩容时，产品 提供简单快捷单元水平扩展能力：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>全国范围内扩展新单元不受地域限制</p>
</li>
<li>
<p>扩展的新单元数量不受限制，单元的稳定性和性能不受单元数量影响</p>
</li>
<li>
<p>提供两种单元扩展形式：独立 DB 的异地单元 、 共享 DB 的同城单元</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用appactive">13.2. 如何使用AppActive</h3>
<div class="sect3">
<h4 id="_数据面">13.2.1. 数据面</h4>
<div class="paragraph">
<p><strong>前置条件</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>需要你的应用服务基于 Java 实现，并且以 Spring Cloud 实现服务调用</p>
</li>
<li>
<p>负载均衡支持 Ribbon，暂不支持 SpringCloudBalancer</p>
</li>
<li>
<p>支持声明式 Http 客户端：OpenFeign 和 RestTemplate，暂不支持 原始 Http 客户端如 OkHttp 和 HttpClient</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>快速接入</strong>
在启动示例进行演示之前，我们先了解一下 Spring Cloud 应用如何使用 AppActive 所提供的异地多活能力。
<strong>注意 本章节只是为了便于您理解接入方式，本示例代码中已经完成接入工作，您无需再进行修改。</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>首先，修改 pom.xml 文件，在 provider 和 consumer 已添加最新 <code>spring-cloud-alibaba-dependencies</code> 的基础上添加以下 maven 依赖。</p>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-appactive&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</li>
<li>
<p>在 Provider 应用的 <code>application.properties</code> 配置文件中给特定接口配置分流策略。其中后缀 <code>core-path</code> 用于配置核心服务，<code>global-path</code> 用于配置全局服务，<code>general-path</code> 用于配置一般服务，比如 demo 中的 product 应用分流策略配置如下：</p>
<div class="literalblock">
<div class="content">
<pre>spring.cloud.appactive.filter.core-path=/detailHidden/*,/detail/*
spring.cloud.appactive.filter.global-path=/buy/*
spring.cloud.appactive.filter.general-path=/*</pre>
</div>
</div>
</li>
<li>
<p>在 Consumer 应用的 <code>application.properties</code> 配置客户端负载均衡为 AppActive 所提供的负载均衡算法，配置方式如下，注意需要将`[service-name]`替换成具体的待消费服务名。</p>
<div class="literalblock">
<div class="content">
<pre>[service-name].ribbon.NFLoadBalancerRuleClassName =com.alibaba.cloud.appactive.consumer.AppactiveRule</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>快速启动</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>启动 Nacos, MySQL, 并往 Nacos 中推送多活规则：</p>
<div class="ulist">
<ul>
<li>
<p>在 <code>appactive-example</code> 目录下，执行：<code>docker-compose -f component-quickstart.yml up -d</code> 启动 Nacos, MySQL。</p>
</li>
<li>
<p>执行以下命令：<code>curl -X POST 'http://127.0.0.1:8848/nacos/v1/console/namespaces' -d 'customNamespaceId=appactiveDemoNamespaceId&amp;namespaceName=appactiveDemoNamespaceName&amp;namespaceDesc=appactiveDemoNamespaceDesc'</code> 在 Nacos 配置中心中创建一个演示用命名空间 appactiveDemoNamespaceId。</p>
</li>
<li>
<p>执行以下命令：<code>sh baseline.sh 2 NACOS appactiveDemoNamespaceId</code>，往命名空间中推送多活规则。多活规则说明如下：</p>
</li>
<li>
<p><code>appactive.dataId.idSourceRulePath</code>: 描述如何从 http 流量中提取路由标</p>
</li>
<li>
<p><code>appactive.dataId.transformerRulePath</code>: 描述如何解析路由标</p>
</li>
<li>
<p><code>appactive.dataId.trafficRouteRulePath</code>: 描述路由标和单元的映射关系</p>
</li>
<li>
<p><code>appactive.dataId.dataScopeRuleDirectoryPath_mysql-product</code>: 描述数据库的属性</p>
</li>
</ul>
</div>
</li>
<li>
<p>启动 5 套应用，启动参数分别为：</p>
<div class="ulist">
<ul>
<li>
<p>frontend</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Dappactive.channelTypeEnum=NACOS
-Dappactive.namespaceId=appactiveDemoNamespaceId
-Dappactive.unit=unit
-Dappactive.app=frontend
-Dio.appactive.demo.unitlist=center,unit
-Dio.appactive.demo.applist=frontend,product,storage
-Dserver.port=8875</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>product</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Dappactive.channelTypeEnum=NACOS
-Dappactive.namespaceId=appactiveDemoNamespaceId
-Dappactive.unit=center
-Dappactive.app=product
-Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/product?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT&amp;activeInstanceId=mysql&amp;activeDbName=product
-Dserver.port=8883</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Dappactive.channelTypeEnum=NACOS
-Dappactive.namespaceId=appactiveDemoNamespaceId
-Dappactive.unit=unit
-Dappactive.app=product
-Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/product?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT&amp;activeInstanceId=mysql&amp;activeDbName=product
-Dserver.port=8873</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>storage</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Dappactive.channelTypeEnum=NACOS
-Dappactive.namespaceId=appactiveDemoNamespaceId
-Dappactive.unit=center
-Dappactive.app=storage
-Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/product?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT
-Dserver.port=8881</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Dappactive.channelTypeEnum=NACOS
-Dappactive.namespaceId=appactiveDemoNamespaceId
-Dappactive.unit=unit
-Dappactive.app=storage
-Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/product?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT
-Dserver.port=8871</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>效果演示</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>归属于一般（Unit）单元的普通应用服务调用演示。在浏览器中输入：<code><a href="http://127.0.0.1:8079/listProduct" class="bare">http://127.0.0.1:8079/listProduct</a></code> 地址，可见请求通过 frontend 应用被发送给了 product。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-16-25-989.png" alt="image 2022 09 15 16 16 25 989">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>由于上述路径中的 `/listProduct` 在 product 应用中匹配到的是 `/*` 路径规则，根据规则内容，该服务属于普通应用做了未做单元化拆分，所以frontend 在从注册中心获取的 product 地址列表中不存在倾向性，会随机选择地址进行请求发送。因此多次请求上述路径，会看到请求在 product 的一般（Unit)和 中心（center）单元应用中来回切换。</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>归属于 unit 单元的核心应用服务调用演示。在浏览器中输入：<code><a href="http://127.0.0.1:8079/detailProduct" class="bare">http://127.0.0.1:8079/detailProduct</a></code> 路径，由于上述路径中的 <code>/detailProduct</code> 在 product 应用中匹配到的是 <code>/detail/*</code> 路径规则，根据规则内容，该服务属于核心应用做了单元会拆分，其会根据请求中 Header, Cookie 或请求参数中的变量具体的值去判断该请求的下游单元类型，由于事先配置如下切流规则（具体可见 rule 目录下的 idUnitMapping.json 文件内容）：</p>
<div class="literalblock">
<div class="content">
<pre>{
  "itemType": "UnitRuleItem",
  "items": [
    {
      "name": "unit",
      "conditions": [
        {
          "@userIdBetween": [
            "0~1999"
          ]
        }
      ]
    },
    {
      "name": "center",
      "conditions": [
        {
          "@userIdBetween": [
            "2000~9999"
          ]
        }
      ]
    }
  ]
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>上述规则表示，用户Id为 0 ~ 1999 的请求将发送给下游提供者中的一般（Unit）单元中的核心应用实例，用户Id为 2000 ~ 9999 的请求将发送给下游提供者中的中心（Center）单元全局应用实例。
如下图，模拟一个用户Id为 1999 的请求，可见请求通过 frontend 发送到了下游中 product 的一般（Unit）单元中的核心应用实例。</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-15-39-851.png" alt="image 2022 09 15 16 15 39 851">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>如下图，模拟一个用户Id为 2000 的请求，可见请求通过 frontend 发送到了下游中 product 的中心（center）单元中的全局应用实例。</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-14-50-461.png" alt="image 2022 09 15 16 14 50 461">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>归属于中心（Center）单元的全局应用服务调用演示。在浏览器中输入：<code><a href="http://127.0.0.1:8079/buyProduct" class="bare">http://127.0.0.1:8079/buyProduct</a></code> 路径，由于上述路径中的 <code>/buyProduct</code> 在 product 和 storage 应用中匹配到的是 <code>/buy/*</code> 路径规则，根据规则内容，该服务属于全局应用未做单元会拆分，其会直接将请求发送到下游的中心（Center）单元中全局应用实例。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-14-02-388.png" alt="image 2022 09 15 16 14 02 388">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>切流演示。切流时主要做了如下几件事：</p>
<div class="ulist">
<ul>
<li>
<p>构建新的映射关系规则和禁写规则（手动）</p>
</li>
<li>
<p>将禁写规则推送给应用</p>
</li>
<li>
<p>等待数据追平后将新的映射关系规则推送给应用
接下来演示的切流规则，会将用户Id为 0 ~ 2999 的请求将发送给下游提供者中的一般（Unit）单元中的核心应用实例，用户Id为 3000 ~ 9999 的请求将发送给下游提供者中的中心（Center）单元中的全局应用实例。具体的规则详情见 idUnitMappingNext.json：</p>
<div class="literalblock">
<div class="content">
<pre>{
  "itemType": "UnitRuleItem",
  "items": [
    {
      "name": "unit",
      "conditions": [
        {
          "@userIdBetween": [
            "0~2999"
          ]
        }
      ]
    },
    {
      "name": "center",
      "conditions": [
        {
          "@userIdBetween": [
            "3000~9999"
          ]
        }
      ]
    }
  ]
}</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>如下图，模拟一个用户Id为 2999 的请求，可见请求通过 frontend 发送到了下游中 product 的 unit 单元中的核心应用实例，切流规则生效。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-12-58-177.png" alt="image 2022 09 15 16 12 58 177">
</div>
</div>
<div class="paragraph">
<p>如下图，模拟一个用户Id为 3000 的请求，可见请求通过 frontend 发送到了下游中 product 的 center 单元中的全局应用实例，切流规则生效。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/image-2022-09-15-16-12-26-461.png" alt="image 2022 09 15 16 12 26 461">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_cloud_alibaba_governance">14. Spring Cloud Alibaba Governance</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="pic/governance-module.png" alt="governance module">
</div>
</div>
<div class="paragraph">
<p>Spring Cloud Alibaba Governance是Spring Cloud Alibaba最新推出的微服务治理能力，提供了多种类型的微服务治理能力，包括标签路由，服务鉴权等。并且对接了多种控制面，比如 <a href="https://istio.io/">Istio</a>，http://opensergo.io/[OpenSergo]，让用户仅通过添加特定的Adapter模块，就能实时感知到上述治理控制面下发的治理规则，并将此规则作用到应用上，从而完成对应用的治理。</p>
</div>
<div class="sect2">
<h3 id="_配置转换">14.1. 配置转换</h3>
<div class="imageblock">
<div class="content">
<img src="pic/resource-transform.png" alt="resource transform">
</div>
</div>
<div class="paragraph">
<p>Microservices Governance的规则转换模块会将不同控制面下发的规则进行统一的转换，目前支持将来自Istio，OpenSergo等控制面下发的规则统一转换为Spring Cloud Alibaba统一抽象出的数据结构以供后续使用</p>
</div>
<div class="paragraph">
<p>如果在项目中使用Istio来实现规则转换，首先注意需要搭建一个Kubernetes集群，并且在其中部署Istio，具体参考 <a href="https://istio.io/latest/zh/docs/setup/install">Istio安装</a>。然后在需要接收到来自Istio规则的应用（一般为服务消费者）中添加如下starter依赖：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-xds-adapter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenSergo请参考 <a href="https://github.com/alibaba/spring-cloud-alibaba/tree/2.2.x/spring-cloud-alibaba-examples/governance-example/label-routing-example">Spring Cloud Alibaba Routing Examples</a></p>
</div>
<div class="paragraph">
<p>之后，在application.yml配置文件中设置如下配置内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">server:
  port: ${SERVER_PORT:80}
spring:
  cloud:
    governance:
      auth:
        enabled: ${ISTIO_AUTH_ENABLE:true}
    istio:
      config:
        enabled: ${ISTIO_CONFIG_ENABLE:true}
        host: ${ISTIOD_ADDR:127.0.0.1}
        port: ${ISTIOD_PORT:15010}
        polling-pool-size: ${POLLING_POOL_SIZE:10}
        polling-time: ${POLLING_TIMEOUT:10}
        istiod-token: ${ISTIOD_TOKEN:}
        log-xds: ${LOG_XDS:true}</code></pre>
</div>
</div>
<div class="paragraph">
<p>各字段的含义如下:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">说明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否开启鉴权</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.governance.auth.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否连接Istio获取鉴权配置</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Istiod的地址</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Istiod的端口</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15012</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">注：连接15010端口无需TLS，连接15012端口需TLS认证</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用从Istio拉取配置的线程池大小</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.polling-pool-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用从Istio拉取配置的间隔时间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.polling-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">单位为秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">连接Istio 15012端口时使用的JWT token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.istiod-token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用所在pod的 <code>/var/run/secrets/tokens/istio-token</code> 文件的内容</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否打印xDS相关日志</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.istio.config.log-xds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>注意，应用运行在K8s环境中，在非默认命名空间下的应用，需要接收Istiod下发的规则，需要将运行的应用K8s的元信息注入以下环境变量中，具体操作方式可参考 <a href="https://kubernetes.io/zh-cn/docs/tasks/inject-data-application/environment-variable-expose-pod-information">Kubernetes文档</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">环境变量名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">K8s pod metadata name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POD_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata.name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAMESPACE_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata.namespace</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_路由">14.2. 路由</h3>
<div class="sect3">
<h4 id="_组件支持说明">14.2.1. 组件支持说明</h4>
<div class="paragraph">
<p>目前，路由模块只支持了部分组件：</p>
</div>
<div class="paragraph">
<p>远程调用组件：Spring Cloud OpenFeign</p>
</div>
<div class="paragraph">
<p>负载均衡组件：Ribbon</p>
</div>
<div class="paragraph">
<p>未来会支持更多的比如RestTemplate，Spring Cloud LoadBalancer等组件。</p>
</div>
</div>
<div class="sect3">
<h4 id="_使用路由">14.2.2. 使用路由</h4>
<div class="paragraph">
<p>在引入配置转换模块后，就能获取到相应的治理规则来对应用赋予相应的治理能力。标签路由模块可以实现对应用根据请求头，请求参数等标签来路由到不同的服务，</p>
</div>
<div class="paragraph">
<p>1.如果在项目中使用Spring Cloud Alibaba 标签路由，需要添加如下starter（一般添加在服务消费者应用上）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-alibaba-governance-routing&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.配置进行路由规则时的负载均衡算法(以随机负载均衡算法为例)
如果未配置，使用Ribbon默认的负载均衡算法ZoneAvoidanceRule</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.governance.routing.rule=RandomRule</pre>
</div>
</div>
<div class="paragraph">
<p>在引入Istio配置转换模块的前提下，标签路由模块支持对以下几种请求的元信息做路由：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>请求路径</p>
</li>
<li>
<p>请求头</p>
</li>
<li>
<p>请求参数</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用Istio下发对应的 <code>DestinationRule</code> 以及 <code>VirtualService</code> ，即可配置对应的标签路由规则，具体的配置方法请参考以下文档与示例：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/#VirtualService">Istio VirtualService</a></p>
</li>
<li>
<p><a href="https://istio.io/latest/zh/docs/concepts/traffic-management/#destination-rules">Istio Destination Rule</a></p>
</li>
<li>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/tree/2.2.x/spring-cloud-alibaba-examples/governance-example/label-routing-example">Spring Cloud Alibaba Routing Examples</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_服务鉴权">14.3. 服务鉴权</h3>
<div class="imageblock">
<div class="content">
<img src="pic/auth-process.png" alt="auth process">
</div>
</div>
<div class="paragraph">
<p>在引入规则转换Adapter后，就能获取到相应的治理规则来对应用赋予相应的治理能力。服务鉴权模块给应用提供多种鉴权方式，如IP黑白名单，JWT鉴权等</p>
</div>
<div class="paragraph">
<p>如果使用Spring Cloud Alibaba服务鉴权功能，需要使用添加如下依赖：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-alibaba-governance-auth&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用Istio下发对应的 <code>AuthorizationPolicy</code> 以及 <code>RequestAuthentication</code> ，即可配置对应的鉴权规则，具体的配置方法请参考以下文档与示例</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://istio.io/latest/zh/docs/reference/config/security/request_authentication/">Istio RequestAuthentication</a></p>
</li>
<li>
<p><a href="https://istio.io/latest/zh/docs/reference/config/security/authorization-policy/">Authorization Policy</a></p>
</li>
<li>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/tree/2.2.x/spring-cloud-alibaba-examples/governance-example/authentication-example">Spring Cloud Alibaba Authorization Examples</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-01-12 20:55:50 +0800
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js"></script>
</body>
</html>